<!-- This template is needed for a toggling solution -->
<!-- https://stackoverflow.com/questions/2454577/sphinx-restructuredtext-show-hide-code-snippets -->

<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>DataProcessor user guide &#8212; Retentioneering 3.0.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../_static/styles/bootstrap.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=796348d33e8b1d947c94" rel="stylesheet">
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2">
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2">
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94">
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/js/custom.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/clipboard@1/dist/clipboard.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'user_guides/dataprocessors';</script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Preprocessing" href="preprocessing.html" />
    <link rel="prev" title="Eventstream" href="eventstream.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="light">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>

  
  <input type="checkbox" class="sidebar-toggle" name="__primary" id="__primary">
  <label class="overlay overlay-primary" for="__primary"></label>

  
  <input type="checkbox" class="sidebar-toggle" name="__secondary" id="__secondary">
  <label class="overlay overlay-secondary" for="__secondary"></label>

  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
      
<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  </div>

  
  <nav class="bd-header navbar navbar-expand-lg bd-navbar" id="navbar-main"><div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
      <span class="fa-solid fa-bars"></span>
  </label>
  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../index.html">

  
  
  
  
  
  
  

  
    <img src="../_static/rete_logo.svg" class="logo__image only-light" alt="Logo image">
    <img src="../_static/rete_logo_white.svg" class="logo__image only-dark" alt="Logo image">
  
  
</a>
    
  </div>

  
  <div class="col-lg-9 navbar-header-items">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../getting_started.html">
                        Getting Started
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../user_guide.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../tutorials.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../datasets.html">
                        Datasets
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../api_reference.html">
                        API Reference
                      </a>
                    </li>
                
    </ul>
</nav>
      </div>
      
    </div>

    <div id="navbar-end">
      
        <div class="navbar-end-item navbar-persistent--container">
          
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
        </div>
      
      
      <div class="navbar-end-item">
        <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>


  
  
    <div class="navbar-persistent--mobile">
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
    </div>
  

  
  <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
  </label>
  

</div>
  </nav>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        
  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../getting_started.html">
                        Getting Started
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../user_guide.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../tutorials.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../datasets.html">
                        Datasets
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../api_reference.html">
                        API Reference
                      </a>
                    </li>
                
    </ul>
</nav>
      </div>
      
      </div>
    

    
    
    <div class="sidebar-header-items__end">
      
      <div class="navbar-end-item">
        <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
    
  </div>

  
  <div class="sidebar-start-items sidebar-primary__section">
    <div class="sidebar-start-items__item"><nav class="bd-links" id="bd-docs-nav" aria-label="Section navigation">
  <p class="bd-links__title" role="heading" aria-level="1">
    Section Navigation
  </p>
  <div class="bd-toc-item navbar-nav">
    <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="eventstream.html"> Eventstream</a></li>
</ul>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#"> DataProcessors</a></li>
<li class="toctree-l1"><a class="reference internal" href="preprocessing.html"> Preprocessing</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="transition_graph.html"> Transition Graph</a></li>
<li class="toctree-l1"><a class="reference internal" href="step_matrix.html"> Step Matrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="step_sankey.html"> Step Sankey</a></li>
<li class="toctree-l1"><a class="reference internal" href="clusters.html"> Clusters</a></li>
<li class="toctree-l1"><a class="reference internal" href="funnel.html"> Funnels</a></li>
<li class="toctree-l1"><a class="reference internal" href="cohorts.html"> Cohorts</a></li>
<li class="toctree-l1"><a class="reference internal" href="stattests.html"> Stattests</a></li>
</ul>

  </div>
</nav>
    </div>
  </div>
  

  
  <div class="sidebar-end-items sidebar-primary__section">
    <div class="sidebar-end-items__item">
    </div>
  </div>

  
  <div id="rtd-footer-container"></div>

      </div>
      <main id="main-content" class="bd-main">
        
        
        <div class="bd-content">
          <div class="bd-article-container">
            
            <div class="bd-header-article">
                
            </div>
            
            
            <article class="bd-article" role="main">
              
  <style>
    .red {color:#24ff83; font-weight:bold;}
</style><section id="dataprocessor-user-guide">
<h1>DataProcessor user guide<a class="headerlink" href="#dataprocessor-user-guide" title="Permalink to this heading">#</a></h1>
<p>The following user guide is also available as
<a class="reference external" href="https://colab.research.google.com/drive/1uXTt14stXKjWR_paEzqPl5_rZLFyclrm?usp=share_link">Google Colab</a></p>
<section id="creating-an-eventstream">
<h2>Creating an eventstream<a class="headerlink" href="#creating-an-eventstream" title="Permalink to this heading">#</a></h2>
<p>Here we use <code class="docutils literal notranslate"><span class="pre">simple_shop</span></code> dataset, which we load as an <code class="docutils literal notranslate"><span class="pre">Eventstream</span></code> object. You can learn more about <code class="docutils literal notranslate"><span class="pre">Eventstream</span></code> in our <a class="reference internal" href="eventstream.html"><span class="doc">eventstream guide</span></a>.
To get an overview of the eventstream concept, see <a class="reference internal" href="../getting_started/eventstream_concept.html"><span class="doc">this guide</span></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">retentioneering</span> <span class="kn">import</span> <span class="n">datasets</span>

<span class="n">stream</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">load_simple_shop</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="what-is-a-dataprocessor">
<h2>What is a DataProcessor?<a class="headerlink" href="#what-is-a-dataprocessor" title="Permalink to this heading">#</a></h2>
<p>Each <code class="docutils literal notranslate"><span class="pre">Data</span> <span class="pre">Processor</span></code> represents an algorithm that modifies eventstream data.</p>
<p>Data processors are designed to be nodes of a
<code class="docutils literal notranslate"><span class="pre">Preprocessing</span> <span class="pre">graph</span></code>, which allows us to apply data processors sequentially, in a custom order.</p>
<p>More about preprocessing graph:</p>
<ul class="simple">
<li><p><a class="reference internal" href="preprocessing.html"><span class="doc">preprocessing guide</span></a></p></li>
</ul>
<figure class="align-default">
<img alt="../_images/dp_0_PGraph.png" src="../_images/dp_0_PGraph.png" />
</figure>
</section>
<section id="general-usage">
<h2>General usage<a class="headerlink" href="#general-usage" title="Permalink to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">retentioneering.graph.p_graph</span> <span class="kn">import</span> <span class="n">PGraph</span><span class="p">,</span> <span class="n">EventsNode</span>

<span class="kn">from</span> <span class="nn">retentioneering.data_processors_lib</span> <span class="kn">import</span> <span class="n">CollapseLoops</span><span class="p">,</span> <span class="n">CollapseLoopsParams</span>
<span class="kn">from</span> <span class="nn">retentioneering.data_processors_lib</span> <span class="kn">import</span> <span class="n">DeleteUsersByPathLength</span><span class="p">,</span> <span class="n">DeleteUsersByPathLengthParams</span>
<span class="kn">from</span> <span class="nn">retentioneering.data_processors_lib</span> <span class="kn">import</span> <span class="n">FilterEvents</span><span class="p">,</span> <span class="n">FilterEventsParams</span>
<span class="kn">from</span> <span class="nn">retentioneering.data_processors_lib</span> <span class="kn">import</span> <span class="n">GroupEvents</span><span class="p">,</span> <span class="n">GroupEventsParams</span>
<span class="kn">from</span> <span class="nn">retentioneering.data_processors_lib</span> <span class="kn">import</span> <span class="n">NewUsersEvents</span><span class="p">,</span> <span class="n">NewUsersParams</span>
<span class="kn">from</span> <span class="nn">retentioneering.data_processors_lib</span> <span class="kn">import</span> <span class="n">LostUsersEvents</span><span class="p">,</span> <span class="n">LostUsersParams</span>
<span class="kn">from</span> <span class="nn">retentioneering.data_processors_lib</span> <span class="kn">import</span> <span class="n">SplitSessions</span><span class="p">,</span> <span class="n">SplitSessionsParams</span>
<span class="kn">from</span> <span class="nn">retentioneering.data_processors_lib</span> <span class="kn">import</span> <span class="n">StartEndEvents</span><span class="p">,</span> <span class="n">StartEndEventsParams</span>
<span class="kn">from</span> <span class="nn">retentioneering.data_processors_lib</span> <span class="kn">import</span> <span class="n">TruncatePath</span><span class="p">,</span> <span class="n">TruncatePathParams</span>
<span class="kn">from</span> <span class="nn">retentioneering.data_processors_lib</span> <span class="kn">import</span> <span class="n">TruncatedEvents</span><span class="p">,</span> <span class="n">TruncatedEventsParams</span>
<span class="kn">from</span> <span class="nn">retentioneering.data_processors_lib</span> <span class="kn">import</span> <span class="n">PositiveTarget</span><span class="p">,</span> <span class="n">PositiveTargetParams</span>
<span class="kn">from</span> <span class="nn">retentioneering.data_processors_lib</span> <span class="kn">import</span> <span class="n">NegativeTarget</span><span class="p">,</span> <span class="n">NegativeTargetParams</span>
</pre></div>
</div>
<p>In order to use each <code class="docutils literal notranslate"><span class="pre">DataProcessor</span></code>, we need to import its class and its parameter class.</p>
<p>We will showcase the usage of data processors by:</p>
<ul class="simple">
<li><p>creating a preprocessing graph instance (<code class="docutils literal notranslate"><span class="pre">PGraph</span></code>)</p></li>
<li><p>creating a dataprocessor instance with specified parameters</p></li>
<li><p>creating a node</p></li>
<li><p>adding node to <code class="docutils literal notranslate"><span class="pre">PGraph</span></code></p></li>
<li><p>combining <code class="docutils literal notranslate"><span class="pre">PGraph</span></code></p></li>
</ul>
<p>Let us create a simple graph with one node:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">graph</span> <span class="o">=</span> <span class="n">PGraph</span><span class="p">(</span><span class="n">source_stream</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
<span class="n">dp_start_end</span> <span class="o">=</span> <span class="n">StartEndEvents</span><span class="p">(</span><span class="n">StartEndEventsParams</span><span class="p">())</span>
<span class="n">node_0</span> <span class="o">=</span> <span class="n">EventsNode</span><span class="p">(</span><span class="n">dp_start_end</span><span class="p">)</span>
<span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="n">node_0</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">graph</span><span class="o">.</span><span class="n">root</span><span class="p">])</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">node_0</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
<span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">219483890</span><span class="p">]</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_type</th>
      <th>event_index</th>
      <th>event</th>
      <th>timestamp</th>
      <th>user_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>path_start</td>
      <td>0</td>
      <td>path_start</td>
      <td>2019-11-01 17:59:13</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>1</th>
      <td>raw</td>
      <td>1</td>
      <td>catalog</td>
      <td>2019-11-01 17:59:13</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>10213</th>
      <td>path_end</td>
      <td>10213</td>
      <td>path_end</td>
      <td>2020-02-14 21:04:52</td>
      <td>219483890</td>
    </tr>
  </tbody>
</table>
</div><p>Adding another node - <code class="docutils literal notranslate"><span class="pre">SplitSessions</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dp_split_sessions</span> <span class="o">=</span> <span class="n">SplitSessions</span><span class="p">(</span><span class="n">SplitSessionsParams</span><span class="p">(</span><span class="n">session_cutoff</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">)))</span>
<span class="n">node_1</span> <span class="o">=</span> <span class="n">EventsNode</span><span class="p">(</span><span class="n">dp_split_sessions</span><span class="p">)</span>

<span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="n">node_1</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">node_0</span><span class="p">])</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">node_1</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
<span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">219483890</span><span class="p">]</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_type</th>
      <th>event_index</th>
      <th>event</th>
      <th>timestamp</th>
      <th>user_id</th>
      <th>session_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>path_start</td>
      <td>0</td>
      <td>path_start</td>
      <td>2019-11-01 17:59:13</td>
      <td>219483890</td>
      <td>219483890_1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>session_start</td>
      <td>2</td>
      <td>session_start</td>
      <td>2019-11-01 17:59:13</td>
      <td>219483890</td>
      <td>219483890_1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>raw</td>
      <td>3</td>
      <td>catalog</td>
      <td>2019-11-01 17:59:13</td>
      <td>219483890</td>
      <td>219483890_1</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>11</th>
      <td>session_end</td>
      <td>11</td>
      <td>session_end</td>
      <td>2019-11-01 17:59:32</td>
      <td>219483890</td>
      <td>219483890_1</td>
    </tr>
    <tr>
      <th>6256</th>
      <td>session_start</td>
      <td>6256</td>
      <td>session_start</td>
      <td>2019-12-06 16:22:57</td>
      <td>219483890</td>
      <td>219483890_2</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>23997</th>
      <td>session_end</td>
      <td>23997</td>
      <td>session_end</td>
      <td>2020-02-14 21:04:52</td>
      <td>219483890</td>
      <td>219483890_4</td>
    </tr>
    <tr>
      <th>23998</th>
      <td>path_end</td>
      <td>23998</td>
      <td>path_end</td>
      <td>2020-02-14 21:04:52</td>
      <td>219483890</td>
      <td>219483890_4</td>
    </tr>
  </tbody>
</table>
</div></section>
<section id="helpers-and-chain-usage">
<h2>Helpers and chain usage<a class="headerlink" href="#helpers-and-chain-usage" title="Permalink to this heading">#</a></h2>
<p>A <code class="docutils literal notranslate"><span class="pre">Helper</span></code> is an <code class="docutils literal notranslate"><span class="pre">Eventstream</span></code> method that applies a single data processor to the data. It is a useful shortcut for
when one wants to avoid creating a preprocessing graph. Each data processor has a corresponding helper method -
the table below showcases the mapping between them:</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Data
processor</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>What it does</p></th>
<th class="head"><p>Helper</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>StartEndEvents</p></td>
<td><p>Adding</p></td>
<td><p>Adds two synthetic events in each user’s path:
<code class="docutils literal notranslate"><span class="pre">path_start</span></code> and <code class="docutils literal notranslate"><span class="pre">path_end</span></code></p></td>
<td><p>add_start_end</p></td>
</tr>
<tr class="row-odd"><td><p>SplitSessions</p></td>
<td><p>Adding</p></td>
<td><p>Cuts user path into sessions and adds synthetic
events <code class="docutils literal notranslate"><span class="pre">session_start</span></code>, <code class="docutils literal notranslate"><span class="pre">session_end</span></code>.</p></td>
<td><p>split_sessions</p></td>
</tr>
<tr class="row-even"><td><p>NewUsersEvents</p></td>
<td><p>Adding</p></td>
<td><p>Adds synthetic event <code class="docutils literal notranslate"><span class="pre">new_user</span></code> in the beginning
of a user’s path if the user is considered as new.
Otherwise adds <code class="docutils literal notranslate"><span class="pre">existing_user</span></code>.</p></td>
<td><p>add_new_users</p></td>
</tr>
<tr class="row-odd"><td><p>LostUsersEvents</p></td>
<td><p>Adding</p></td>
<td><p>Adds synthetic event <code class="docutils literal notranslate"><span class="pre">lost_user</span></code> in the end of
user’s path if the user never comes back to the
product. Otherwise adds <code class="docutils literal notranslate"><span class="pre">absent_user</span></code> event.</p></td>
<td><p>lost_users</p></td>
</tr>
<tr class="row-even"><td><p>PositiveTarget</p></td>
<td><p>Adding</p></td>
<td><p>Adds synthetic event <code class="docutils literal notranslate"><span class="pre">positive_target</span></code> for all
events which are considered as positive.</p></td>
<td><p>positive_target</p></td>
</tr>
<tr class="row-odd"><td><p>NegativeTarget</p></td>
<td><p>Adding</p></td>
<td><p>Adds synthetic event <code class="docutils literal notranslate"><span class="pre">negative_target</span></code> for all
events which are considered as positive.</p></td>
<td><p>negative_target</p></td>
</tr>
<tr class="row-even"><td><p>TruncatedEvents</p></td>
<td><p>Adding</p></td>
<td><p>Adds synthetic events <code class="docutils literal notranslate"><span class="pre">truncated_left</span></code> and/or
<code class="docutils literal notranslate"><span class="pre">truncated_right</span></code> for those user paths which are
considered as truncated by the edges of the whole
dataset.</p></td>
<td><p>truncated_events</p></td>
</tr>
<tr class="row-odd"><td><p>FilterEvents</p></td>
<td><p>Removing</p></td>
<td><p>Remove events from an eventstream</p></td>
<td><p>filter</p></td>
</tr>
<tr class="row-even"><td><p>DeleteUsersByPathLength</p></td>
<td><p>Removing</p></td>
<td><p>Deletes a too short user paths (in terms of number
of events or time duration).</p></td>
<td><p>delete_users</p></td>
</tr>
<tr class="row-odd"><td><p>TruncatePath</p></td>
<td><p>Removing</p></td>
<td><p>Leaves a part of an eventstream between a couple
of selected events.</p></td>
<td><p>truncate_path</p></td>
</tr>
<tr class="row-even"><td><p>GroupEvents</p></td>
<td><p>Grouping</p></td>
<td><p>Group given events into a single synthetic event.</p></td>
<td><p>group</p></td>
</tr>
<tr class="row-odd"><td><p>CollapseLoops</p></td>
<td><p>Grouping</p></td>
<td><p>Replaces sequences of repetitive events with new
synthetic events. E.g. <code class="docutils literal notranslate"><span class="pre">A,</span> <span class="pre">A,</span> <span class="pre">A</span> <span class="pre">-&gt;</span> <span class="pre">A</span></code>.</p></td>
<td><p>collapse_loops</p></td>
</tr>
</tbody>
</table>
<p>Method chaining is supported for <code class="docutils literal notranslate"><span class="pre">helpers</span></code> as it is present in other
python libraries, for example in Pandas.</p>
<p>Using helper methods, we can replicate the <em>General Usage</em> coding blocks output:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">add_start_end</span><span class="p">()</span><span class="o">.</span><span class="n">split_sessions</span><span class="p">(</span><span class="n">session_cutoff</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
<span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">219483890</span><span class="p">]</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_type</th>
      <th>event_index</th>
      <th>event</th>
      <th>timestamp</th>
      <th>user_id</th>
      <th>session_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>path_start</td>
      <td>0</td>
      <td>path_start</td>
      <td>2019-11-01 17:59:13</td>
      <td>219483890</td>
      <td>219483890_1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>session_start</td>
      <td>2</td>
      <td>session_start</td>
      <td>2019-11-01 17:59:13</td>
      <td>219483890</td>
      <td>219483890_1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>raw</td>
      <td>3</td>
      <td>catalog</td>
      <td>2019-11-01 17:59:13</td>
      <td>219483890</td>
      <td>219483890_1</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>11</th>
      <td>session_end</td>
      <td>11</td>
      <td>session_end</td>
      <td>2019-11-01 17:59:32</td>
      <td>219483890</td>
      <td>219483890_1</td>
    </tr>
    <tr>
      <th>6256</th>
      <td>session_start</td>
      <td>6256</td>
      <td>session_start</td>
      <td>2019-12-06 16:22:57</td>
      <td>219483890</td>
      <td>219483890_2</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>23997</th>
      <td>session_end</td>
      <td>23997</td>
      <td>session_end</td>
      <td>2020-02-14 21:04:52</td>
      <td>219483890</td>
      <td>219483890_4</td>
    </tr>
    <tr>
      <th>23998</th>
      <td>path_end</td>
      <td>23998</td>
      <td>path_end</td>
      <td>2020-02-14 21:04:52</td>
      <td>219483890</td>
      <td>219483890_4</td>
    </tr>
  </tbody>
</table>
</div><p>We will also use <code class="docutils literal notranslate"><span class="pre">helpers</span></code> in the section below.</p>
</section>
<section id="data-processors-library">
<h2>Data Processors library<a class="headerlink" href="#data-processors-library" title="Permalink to this heading">#</a></h2>
<p>Data processors can be partitioned into three groups:</p>
<ul class="simple">
<li><p>Adding: processors that add events to an eventstream,</p></li>
<li><p>Removing: processors that remove events from an eventstream,</p></li>
<li><p>Editing: processors that modify existing events in an eventstream (including grouping operations).</p></li>
</ul>
<section id="adding-processors">
<h3>Adding processors<a class="headerlink" href="#adding-processors" title="Permalink to this heading">#</a></h3>
<p>The processors of that type add some artificial (<em>synthetic</em>) events to an eventstream.</p>
<section id="startendevents">
<h4>StartEndEvents<a class="headerlink" href="#startendevents" title="Permalink to this heading">#</a></h4>
<p>For each user, <code class="docutils literal notranslate"><span class="pre">StartEndEvents</span></code> generates an event
called <code class="docutils literal notranslate"><span class="pre">path_start</span></code> right before the first user event, and an event
<code class="docutils literal notranslate"><span class="pre">path_end</span></code> right after the last user event.</p>
<figure class="align-default">
<img alt="../_images/dp_1_start_end.png" src="../_images/dp_1_start_end.png" />
</figure>
<p>Applying <code class="docutils literal notranslate"><span class="pre">StartEndEvents</span></code> to mark user trajectory start and finish:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">add_start_end</span><span class="p">()</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
<span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">219483890</span><span class="p">]</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_type</th>
      <th>event_index</th>
      <th>event</th>
      <th>timestamp</th>
      <th>user_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>path_start</td>
      <td>0</td>
      <td>path_start</td>
      <td>2019-11-01 17:59:13</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>1</th>
      <td>raw</td>
      <td>1</td>
      <td>catalog</td>
      <td>2019-11-01 17:59:13</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>10213</th>
      <td>path_end</td>
      <td>10213</td>
      <td>path_end</td>
      <td>2020-02-14 21:04:52</td>
      <td>219483890</td>
    </tr>
  </tbody>
</table>
</div><p>As we see from the dataframe above, the generated events <code class="docutils literal notranslate"><span class="pre">path_start</span></code>
and <code class="docutils literal notranslate"><span class="pre">path_end</span></code> have the same timestamps as the corresponding first and
last events.</p>
<p>We recommend applying this data processor each time you analyze an
eventstream - since it sets the borders of an eventstream explicitly. It
can be useful for plotting and analyzing user lifetime across all users,
or conveniently displaying user trajectory borders in
<code class="docutils literal notranslate"><span class="pre">TransitionGraph</span></code>, <code class="docutils literal notranslate"><span class="pre">StepMatrix</span></code>, and <code class="docutils literal notranslate"><span class="pre">StepSankey</span></code> tools.</p>
</section>
<section id="splitsessions">
<h4>SplitSessions<a class="headerlink" href="#splitsessions" title="Permalink to this heading">#</a></h4>
<p>Cuts user paths into sessions based on the defined <code class="docutils literal notranslate"><span class="pre">session_cutoff</span></code>
timeout parameter. For each session, it creates a couple of synthetic
events <code class="docutils literal notranslate"><span class="pre">session_start</span></code> and <code class="docutils literal notranslate"><span class="pre">session_end</span></code> in a manner similar to
<code class="docutils literal notranslate"><span class="pre">StartEndEvents</span></code>. Session identifiers are formed according to the
template <code class="docutils literal notranslate"><span class="pre">&lt;user_id&gt;_&lt;user_session_number&gt;</span></code>, and can be found in
<code class="docutils literal notranslate"><span class="pre">session_id</span></code> column. The <code class="docutils literal notranslate"><span class="pre">user_session_number</span></code> is associated with a
session ordinal number within a user path and always starts with 1.</p>
<figure class="align-default">
<img alt="../_images/dp_2_split_sessions.png" src="../_images/dp_2_split_sessions.png" />
</figure>
<p>Applying <code class="docutils literal notranslate"><span class="pre">SplitSessions</span></code> to split user paths into sessions with
session cutoff = 10 minutes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">split_sessions</span><span class="p">(</span><span class="n">session_cutoff</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
<span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">219483890</span><span class="p">]</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_type</th>
      <th>event_index</th>
      <th>event</th>
      <th>timestamp</th>
      <th>user_id</th>
      <th>session_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>session_start</td>
      <td>0</td>
      <td>session_start</td>
      <td>2019-11-01 17:59:13</td>
      <td>219483890</td>
      <td>219483890_1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>raw</td>
      <td>1</td>
      <td>catalog</td>
      <td>2019-11-01 17:59:13</td>
      <td>219483890</td>
      <td>219483890_1</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>9</th>
      <td>session_end</td>
      <td>9</td>
      <td>session_end</td>
      <td>2019-11-01 17:59:32</td>
      <td>219483890</td>
      <td>219483890_1</td>
    </tr>
    <tr>
      <th>5316</th>
      <td>session_start</td>
      <td>5316</td>
      <td>session_start</td>
      <td>2019-12-06 16:22:57</td>
      <td>219483890</td>
      <td>219483890_2</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>21049</th>
      <td>session_end</td>
      <td>21049</td>
      <td>session_end</td>
      <td>2020-02-14 21:04:52</td>
      <td>219483890</td>
      <td>219483890_4</td>
    </tr>
  </tbody>
</table>
</div><p>The result for one user is displayed above. We see that the user
trajectory is partitioned into three sessions. The time distance between
consecutive events within each session is less than 10 minutes.</p>
<p>Splitting user paths into sessions is an essential step in clickstream
analysis. Sometimes, it is not clear which session cutoff is the best
; in such cases, it
can be a good practice to generate multiple session splits, and compare
them in some fashion. (timedelta_hist
<span class="red">TODO: link to timedelta_hist. dpanina</span>
method can be useful here)</p>
</section>
<section id="newusersevents">
<h4>NewUsersEvents<a class="headerlink" href="#newusersevents" title="Permalink to this heading">#</a></h4>
<p>Given a list of users (considered “new”), the method labels those users in
an eventstream by adding a synthetic <code class="docutils literal notranslate"><span class="pre">new_user</span></code> event to each
user trajectory start. For all other users, adds an
<code class="docutils literal notranslate"><span class="pre">existing_user</span></code> synthetic event. When passed <code class="docutils literal notranslate"><span class="pre">'all'</span></code> instead of a
list, all users will be labeled as new.</p>
<figure class="align-default">
<img alt="../_images/dp_3_new_users.png" src="../_images/dp_3_new_users.png" />
</figure>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">new_users</span> <span class="o">=</span> <span class="p">[</span><span class="mi">219483890</span><span class="p">,</span> <span class="mi">964964743</span><span class="p">,</span> <span class="mi">965024600</span><span class="p">]</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">add_new_users</span><span class="p">(</span><span class="n">new_users_list</span><span class="o">=</span><span class="n">new_users</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
<span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">219483890</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_type</th>
      <th>event_index</th>
      <th>event</th>
      <th>timestamp</th>
      <th>user_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>new_user</td>
      <td>0</td>
      <td>new_user</td>
      <td>2019-11-01 17:59:13</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>1</th>
      <td>raw</td>
      <td>1</td>
      <td>catalog</td>
      <td>2019-11-01 17:59:13</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>2</th>
      <td>raw</td>
      <td>2</td>
      <td>product1</td>
      <td>2019-11-01 17:59:28</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>3</th>
      <td>raw</td>
      <td>3</td>
      <td>cart</td>
      <td>2019-11-01 17:59:29</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>4</th>
      <td>raw</td>
      <td>4</td>
      <td>catalog</td>
      <td>2019-11-01 17:59:32</td>
      <td>219483890</td>
    </tr>
  </tbody>
</table>
</div><p>We can see that user <code class="docutils literal notranslate"><span class="pre">219483890</span></code> is marked as a new user.</p>
<p>But user <code class="docutils literal notranslate"><span class="pre">501098384</span></code> is marked as an existing user:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">501098384</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_type</th>
      <th>event_index</th>
      <th>event</th>
      <th>timestamp</th>
      <th>user_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>17387</th>
      <td>existing_user</td>
      <td>17387</td>
      <td>existing_user</td>
      <td>2020-04-02 05:36:04</td>
      <td>501098384</td>
    </tr>
    <tr>
      <th>17388</th>
      <td>raw</td>
      <td>17388</td>
      <td>main</td>
      <td>2020-04-02 05:36:04</td>
      <td>501098384</td>
    </tr>
    <tr>
      <th>17389</th>
      <td>raw</td>
      <td>17389</td>
      <td>catalog</td>
      <td>2020-04-02 05:36:05</td>
      <td>501098384</td>
    </tr>
    <tr>
      <th>17390</th>
      <td>raw</td>
      <td>17390</td>
      <td>main</td>
      <td>2020-04-02 05:36:40</td>
      <td>501098384</td>
    </tr>
    <tr>
      <th>17391</th>
      <td>raw</td>
      <td>17391</td>
      <td>catalog</td>
      <td>2020-04-02 05:36:41</td>
      <td>501098384</td>
    </tr>
  </tbody>
</table>
</div><p>This data processor can be useful when you have data that chronologically
precedes the clickstream you are working with. For instance, your
clickstream might be covering 1-month user data, while also having the
user login data for the whole year. In that case, you can use <code class="docutils literal notranslate"><span class="pre">NewUsersEvents</span></code>
to split users into two categories - new users, and users who have
appeared this year before.</p>
</section>
<section id="lostusersevents">
<h4>LostUsersEvents<a class="headerlink" href="#lostusersevents" title="Permalink to this heading">#</a></h4>
<p>Given a list of users (considered “lost”), the method labels those
users by adding a synthetic <code class="docutils literal notranslate"><span class="pre">lost_user</span></code> event to each
user trajectory end. For all other users, adds an
<code class="docutils literal notranslate"><span class="pre">absent_user</span></code> synthetic event. When passed a <code class="docutils literal notranslate"><span class="pre">lost_cutoff</span></code> timedelta value,
the method labels users based on the following strategy: if the
timedelta between the user last event and the eventstream last event
exceeds <code class="docutils literal notranslate"><span class="pre">lost_cutoff</span></code>, label as <code class="docutils literal notranslate"><span class="pre">lost_user</span></code>; otherwise, label as
<code class="docutils literal notranslate"><span class="pre">absent_user</span></code>.</p>
<p><span class="red">TODO: Make an image illustrating lost_cutoff parameter. dpanina</span></p>
<figure class="align-default">
<img alt="../_images/dp_4_lost_users.png" src="../_images/dp_4_lost_users.png" />
</figure>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lost_users_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">219483890</span><span class="p">,</span> <span class="mi">964964743</span><span class="p">,</span> <span class="mi">965024600</span><span class="p">]</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">lost_users</span><span class="p">(</span><span class="n">lost_users_list</span><span class="o">=</span><span class="n">lost_users_list</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
<span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">219483890</span><span class="p">]</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_type</th>
      <th>event_index</th>
      <th>event</th>
      <th>timestamp</th>
      <th>user_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>5175</th>
      <td>raw</td>
      <td>5175</td>
      <td>catalog</td>
      <td>2020-01-06 22:11:28</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>9329</th>
      <td>raw</td>
      <td>9329</td>
      <td>main</td>
      <td>2020-02-14 21:04:49</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>9330</th>
      <td>raw</td>
      <td>9330</td>
      <td>catalog</td>
      <td>2020-02-14 21:04:51</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>9332</th>
      <td>lost_user</td>
      <td>9332</td>
      <td>lost_user</td>
      <td>2020-02-14 21:04:52</td>
      <td>219483890</td>
    </tr>
  </tbody>
</table>
</div><p>As opposed to user <code class="docutils literal notranslate"><span class="pre">219483890</span></code>, the user <code class="docutils literal notranslate"><span class="pre">501098384</span></code> is labeled as an
<code class="docutils literal notranslate"><span class="pre">absent_user</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">501098384</span><span class="p">]</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_type</th>
      <th>event_index</th>
      <th>event</th>
      <th>timestamp</th>
      <th>user_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>39127</th>
      <td>raw</td>
      <td>39127</td>
      <td>catalog</td>
      <td>2020-04-29 12:48:01</td>
      <td>501098384</td>
    </tr>
    <tr>
      <th>39128</th>
      <td>raw</td>
      <td>39128</td>
      <td>main</td>
      <td>2020-04-29 12:48:01</td>
      <td>501098384</td>
    </tr>
    <tr>
      <th>39129</th>
      <td>raw</td>
      <td>39129</td>
      <td>catalog</td>
      <td>2020-04-29 12:48:06</td>
      <td>501098384</td>
    </tr>
    <tr>
      <th>39130</th>
      <td>absent_user</td>
      <td>39130</td>
      <td>absent_user</td>
      <td>2020-04-29 12:48:06</td>
      <td>501098384</td>
    </tr>
  </tbody>
</table>
</div><p>The function of this dataprocessor is similar to
<code class="docutils literal notranslate"><span class="pre">NewUsersEvents</span></code>, except for the fact that it adds labels to the end
of user trajectory.</p>
<p>We can also run <code class="docutils literal notranslate"><span class="pre">LostUsersEvents</span></code> with <code class="docutils literal notranslate"><span class="pre">lost_cutoff</span></code> passed, to
arbitrarily label some users as lost. Assume we consider a user as
absent if there has been no events for 30 days:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">lost_users</span><span class="p">(</span><span class="n">lost_cutoff</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
</pre></div>
</div>
<p>Before we inspect the results of applying the data processor,
notice that the eventstream ends at <code class="docutils literal notranslate"><span class="pre">2020-04-29</span> <span class="pre">12:48:07</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2020-04-29 12:48:07.595390&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>User <code class="docutils literal notranslate"><span class="pre">495985018</span></code> is labeled as lost, since her last event occurred
on <code class="docutils literal notranslate"><span class="pre">2019-11-02</span></code>. It’s more than 30 days before the end of the
eventstream.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">495985018</span><span class="p">]</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_type</th>
      <th>event_index</th>
      <th>event</th>
      <th>timestamp</th>
      <th>user_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>47</th>
      <td>raw</td>
      <td>47</td>
      <td>catalog</td>
      <td>2019-11-02 01:14:08</td>
      <td>495985018</td>
    </tr>
    <tr>
      <th>48</th>
      <td>raw</td>
      <td>48</td>
      <td>cart</td>
      <td>2019-11-02 01:14:37</td>
      <td>495985018</td>
    </tr>
    <tr>
      <th>49</th>
      <td>lost_user</td>
      <td>49</td>
      <td>lost_user</td>
      <td>2019-11-02 01:14:37</td>
      <td>495985018</td>
    </tr>
  </tbody>
</table>
</div><p>On the other hand, user <code class="docutils literal notranslate"><span class="pre">819489198</span></code> is labeled as <code class="docutils literal notranslate"><span class="pre">absent</span></code> because
her last event occurred on <code class="docutils literal notranslate"><span class="pre">2020-04-15</span></code>, which is less than 30 days
before <code class="docutils literal notranslate"><span class="pre">2020-04-29</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">819489198</span><span class="p">]</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_type</th>
      <th>event_index</th>
      <th>event</th>
      <th>timestamp</th>
      <th>user_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>26529</th>
      <td>raw</td>
      <td>26529</td>
      <td>main</td>
      <td>2020-04-15 21:02:36</td>
      <td>819489198</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>26544</th>
      <td>raw</td>
      <td>26544</td>
      <td>payment_card</td>
      <td>2020-04-15 21:03:46</td>
      <td>819489198</td>
    </tr>
    <tr>
      <th>26545</th>
      <td>raw</td>
      <td>26545</td>
      <td>payment_done</td>
      <td>2020-04-15 21:03:47</td>
      <td>819489198</td>
    </tr>
    <tr>
      <th>26546</th>
      <td>absent_user</td>
      <td>26546</td>
      <td>absent_user</td>
      <td>2020-04-15 21:03:47</td>
      <td>819489198</td>
    </tr>
  </tbody>
</table>
</div></section>
<section id="positivetarget">
<h4>PositiveTarget<a class="headerlink" href="#positivetarget" title="Permalink to this heading">#</a></h4>
<p>This dataprocessor supports two parameters:</p>
<ul class="simple">
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">positive_target_events</span></code> - list of “positive” <code class="docutils literal notranslate"><span class="pre">events</span></code></dt><dd><p>(for instance, associated with some conversion goal of the user behavior)</p>
</dd>
</dl>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">func</span></code> - this function accepts parent <code class="docutils literal notranslate"><span class="pre">Eventstream</span></code> as an
argument and returns <code class="docutils literal notranslate"><span class="pre">pandas.DataFrame</span></code>, containing only the lines
of the events we would like to label as positive.</p></li>
</ul>
<p>By default, for each user trajectory, an event from the
specified list (and minimum timestamp) is taken and cloned with
<code class="docutils literal notranslate"><span class="pre">positive_target_&lt;EVENTNAME&gt;</span></code> as <code class="docutils literal notranslate"><span class="pre">event</span></code> and <code class="docutils literal notranslate"><span class="pre">positive_target</span></code>
type.</p>
<figure class="align-default">
<img alt="../_images/dp_5_positive.png" src="../_images/dp_5_positive.png" />
</figure>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">positive_events</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cart&#39;</span><span class="p">,</span> <span class="s1">&#39;payment_done&#39;</span><span class="p">]</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">positive_target</span><span class="p">(</span><span class="n">positive_target_events</span><span class="o">=</span><span class="n">positive_events</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
</pre></div>
</div>
<p>Consider user <code class="docutils literal notranslate"><span class="pre">219483890</span></code> who has <code class="docutils literal notranslate"><span class="pre">cart</span></code> event appeared in her
trajectory with <code class="docutils literal notranslate"><span class="pre">event_index</span> <span class="pre">=</span> <span class="pre">2</span></code>. A synthetic event
<code class="docutils literal notranslate"><span class="pre">positive_target_cart</span></code> is added right after it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">219483890</span><span class="p">]</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_type</th>
      <th>event_index</th>
      <th>event</th>
      <th>timestamp</th>
      <th>user_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>raw</td>
      <td>0</td>
      <td>catalog</td>
      <td>2019-11-01 17:59:13</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>1</th>
      <td>raw</td>
      <td>1</td>
      <td>product1</td>
      <td>2019-11-01 17:59:28</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>2</th>
      <td>raw</td>
      <td>2</td>
      <td>cart</td>
      <td>2019-11-01 17:59:29</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>3</th>
      <td>positive_target</td>
      <td>3</td>
      <td>positive_target_cart</td>
      <td>2019-11-01 17:59:29</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>5116</th>
      <td>raw</td>
      <td>5116</td>
      <td>cart</td>
      <td>2020-01-06 22:10:42</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>5117</th>
      <td>raw</td>
      <td>5117</td>
      <td>catalog</td>
      <td>2020-01-06 22:10:52</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>9187</th>
      <td>raw</td>
      <td>9187</td>
      <td>catalog</td>
      <td>2020-02-14 21:04:51</td>
      <td>219483890</td>
    </tr>
  </tbody>
</table>
</div><p>In opposite to this user, user <code class="docutils literal notranslate"><span class="pre">24427596</span></code> has no positive events, so
her path remains unchanged:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">24427596</span><span class="p">]</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_type</th>
      <th>event_index</th>
      <th>event</th>
      <th>timestamp</th>
      <th>user_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>68</th>
      <td>raw</td>
      <td>68</td>
      <td>main</td>
      <td>2019-11-02 07:28:07</td>
      <td>24427596</td>
    </tr>
    <tr>
      <th>69</th>
      <td>raw</td>
      <td>69</td>
      <td>catalog</td>
      <td>2019-11-02 07:28:14</td>
      <td>24427596</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>71</th>
      <td>raw</td>
      <td>71</td>
      <td>catalog</td>
      <td>2019-11-02 07:29:42</td>
      <td>24427596</td>
    </tr>
  </tbody>
</table>
</div><p>This data processor can make it easier to label events that we would
like to consider positive. This might come useful for the further analysis,
with such tools as <code class="docutils literal notranslate"><span class="pre">TransitionGraph</span></code>, <code class="docutils literal notranslate"><span class="pre">StepMatrix</span></code>, and
<code class="docutils literal notranslate"><span class="pre">SankeyStep</span></code> - as it will help to highlight the positive events.</p>
<p>Another way to set positive events is to pass a custom function in <code class="docutils literal notranslate"><span class="pre">func</span></code>.
For example, assume we need to mark each <code class="docutils literal notranslate"><span class="pre">positive_target_event</span></code> in a trajectory, not just the
first one:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">custom_func</span><span class="p">(</span><span class="n">eventstream</span><span class="p">,</span> <span class="n">positive_target_events</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>

    <span class="n">event_col</span> <span class="o">=</span> <span class="n">eventstream</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">event_name</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">eventstream</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">event_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">positive_target_events</span><span class="p">)]</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">positive_target</span><span class="p">(</span><span class="n">positive_target_events</span><span class="o">=</span><span class="n">positive_events</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">custom_func</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">219483890</span><span class="p">]</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_type</th>
      <th>event_index</th>
      <th>event</th>
      <th>timestamp</th>
      <th>user_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>raw</td>
      <td>0</td>
      <td>catalog</td>
      <td>2019-11-01 17:59:13</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>1</th>
      <td>raw</td>
      <td>1</td>
      <td>product1</td>
      <td>2019-11-01 17:59:28</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>2</th>
      <td>raw</td>
      <td>2</td>
      <td>cart</td>
      <td>2019-11-01 17:59:29</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>3</th>
      <td>positive_target</td>
      <td>3</td>
      <td>positive_target_cart</td>
      <td>2019-11-01 17:59:29</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>5116</th>
      <td>raw</td>
      <td>5116</td>
      <td>cart</td>
      <td>2020-01-06 22:10:42</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>5117</th>
      <td>positive_target</td>
      <td>5117</td>
      <td>positive_target_cart</td>
      <td>2020-01-06 22:10:42</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>5118</th>
      <td>raw</td>
      <td>5118</td>
      <td>catalog</td>
      <td>2020-01-06 22:10:52</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>9188</th>
      <td>raw</td>
      <td>9188</td>
      <td>catalog</td>
      <td>2020-02-14 21:04:51</td>
      <td>219483890</td>
    </tr>
  </tbody>
</table>
</div></section>
<section id="negativetarget">
<h4>NegativeTarget<a class="headerlink" href="#negativetarget" title="Permalink to this heading">#</a></h4>
<p>The idea of <code class="docutils literal notranslate"><span class="pre">NegativeTarget</span></code> data processor is exactly the same as for
<code class="docutils literal notranslate"><span class="pre">PositiveTarget</span></code>, but applied to negative labels instead of
positive.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">negative_target_events</span></code> - list of “negative” <a href="#id1"><span class="problematic" id="id2">``</span></a>events``(for example, associated with some
negative result of the user behavior)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">func</span></code> - this function accepts parent <code class="docutils literal notranslate"><span class="pre">Eventstream</span></code> as an
argument and returns <code class="docutils literal notranslate"><span class="pre">pandas.DataFrame</span></code>, containing only the lines
of the events we would like to label as negative.</p></li>
</ul>
<figure class="align-default">
<img alt="../_images/dp_6_negative.png" src="../_images/dp_6_negative.png" />
</figure>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">negative_events</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;delivery_courier&#39;</span><span class="p">]</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">negative_target</span><span class="p">(</span><span class="n">negative_target_events</span><span class="o">=</span><span class="n">negative_events</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
</pre></div>
</div>
<p>Works similarly to the <code class="docutils literal notranslate"><span class="pre">PositiveTarget</span></code> dataprocessor - in this
case, it will add negative event next to the <code class="docutils literal notranslate"><span class="pre">delivery_courier</span></code> event:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">629881394</span><span class="p">]</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_type</th>
      <th>event_index</th>
      <th>event</th>
      <th>timestamp</th>
      <th>user_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>7</th>
      <td>raw</td>
      <td>7</td>
      <td>main</td>
      <td>2019-11-01 22:28:54</td>
      <td>629881394</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>39</th>
      <td>raw</td>
      <td>39</td>
      <td>delivery_courier</td>
      <td>2019-11-01 22:36:02</td>
      <td>629881394</td>
    </tr>
    <tr>
      <th>41</th>
      <td>negative_target</td>
      <td>41</td>
      <td>negative_target_delivery_courier</td>
      <td>2019-11-01 22:36:02</td>
      <td>629881394</td>
    </tr>
    <tr>
      <th>44</th>
      <td>raw</td>
      <td>44</td>
      <td>payment_choice</td>
      <td>2019-11-01 22:36:02</td>
      <td>629881394</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>..</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>13724</th>
      <td>raw</td>
      <td>13724</td>
      <td>catalog</td>
      <td>2020-03-30 03:19:59</td>
      <td>629881394</td>
    </tr>
  </tbody>
</table>
</div></section>
<section id="truncatedevents">
<h4>TruncatedEvents<a class="headerlink" href="#truncatedevents" title="Permalink to this heading">#</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">TruncatedEvents</span></code> addresses a common practical problem, when some
trajectories are truncated due to the dataset’s natural
boundaries.</p>
<figure class="align-default">
<img alt="../_images/dp_7_truncate_timeline.png" src="../_images/dp_7_truncate_timeline.png" />
</figure>
<p>The diagram above illustrates this problem. Consider two user paths –
blue and orange. In
reality, the blue path started before the beginning of the eventstream.
But we cannot observe that - since we observe no events to the left from the
beginning of the eventstream.
So, instead of the real start of the user path, we observe a “false”
beginning, and the observed trajectory is truncated.</p>
<p>A similar situation occurs with the orange user path. Instead of the
real trajectory end, we only observe the “false” trajectory end.</p>
<p>One possible way to mark truncated paths is to detect
trajectories that are “too short” for a typical trajectory, and
whose shortness can be attributed to being truncated.</p>
<p><code class="docutils literal notranslate"><span class="pre">TruncatedEvents</span></code> data processor uses passed <code class="docutils literal notranslate"><span class="pre">left_truncated_cutoff</span></code> and
<code class="docutils literal notranslate"><span class="pre">right_truncated_cutoff</span></code> timedeltas, and labels user trajectories as
<code class="docutils literal notranslate"><span class="pre">truncated_left</span></code> or <code class="docutils literal notranslate"><span class="pre">truncated_right</span></code> based on the following
policy:</p>
<ul class="simple">
<li><p>if the last event of a user trajectory is distanced from the first
event of the whole eventstream by less than
<code class="docutils literal notranslate"><span class="pre">left_truncated_cutoff</span></code>, consider the user trajectory truncated
from the left, and create <code class="docutils literal notranslate"><span class="pre">truncated_left</span></code> synthetic event at the
trajectory start;</p></li>
<li><p>if the first event of a user trajectory is distanced from the last
event of the whole eventstream by less than
<code class="docutils literal notranslate"><span class="pre">right_truncated_cutoff</span></code>, consider the user trajectory truncated
from the right, and create <code class="docutils literal notranslate"><span class="pre">truncated_right</span></code> synthetic event at the
trajectory end.</p></li>
</ul>
<figure class="align-default">
<img alt="../_images/dp_8_truncate.png" src="../_images/dp_8_truncate.png" />
</figure>
<p>Sometimes, it can be a good practice to use different cutoff values, and
compare them in some fashion to select the best. timedelta_hist
<span class="red">TODO: link to timedelta_hist. dpanina</span> method
with specified <code class="docutils literal notranslate"><span class="pre">event_pair=('path_start',</span> <span class="pre">'cart')</span></code> can be useful for this.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;left_truncated_cutoff&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">),</span>
    <span class="s1">&#39;right_truncated_cutoff&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">truncated_events</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
</pre></div>
</div>
<p>Displaying the eventstream start and end timestamps:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Eventstream start: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Eventstream end: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Eventstream</span> <span class="n">start</span><span class="p">:</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">01</span> <span class="mi">17</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mf">13.273932</span>
<span class="n">Eventstream</span> <span class="n">end</span><span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mf">07.595390</span>
</pre></div>
</div>
<p>The trajectory of the following user ends at <code class="docutils literal notranslate"><span class="pre">2019-11-02</span> <span class="pre">01:14:38</span></code> - which is too
close to the eventstream start(for the given <code class="docutils literal notranslate"><span class="pre">left_truncated_cutoff</span></code>
value), so the <code class="docutils literal notranslate"><span class="pre">TruncatedEvents</span></code> dataprocessor labels it as truncated
from the left:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">495985018</span><span class="p">]</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_type</th>
      <th>event_index</th>
      <th>event</th>
      <th>timestamp</th>
      <th>user_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>47</th>
      <td>truncated_left</td>
      <td>47</td>
      <td>truncated_left</td>
      <td>2019-11-02 01:14:08</td>
      <td>495985018</td>
    </tr>
    <tr>
      <th>48</th>
      <td>raw</td>
      <td>48</td>
      <td>catalog</td>
      <td>2019-11-02 01:14:08</td>
      <td>495985018</td>
    </tr>
    <tr>
      <th>49</th>
      <td>raw</td>
      <td>49</td>
      <td>cart</td>
      <td>2019-11-02 01:14:37</td>
      <td>495985018</td>
    </tr>
  </tbody>
</table>
</div><p>The trajectory of the following user starts at <code class="docutils literal notranslate"><span class="pre">2020-04-29</span> <span class="pre">12:24:21</span></code> - which is too
close to the eventstream end(for the given <code class="docutils literal notranslate"><span class="pre">right_truncated_cutoff</span></code>
value), so
the <code class="docutils literal notranslate"><span class="pre">TruncatedEvents</span></code> data processor labels it as truncated from the
right:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">831491833</span><span class="p">]</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_type</th>
      <th>event_index</th>
      <th>event</th>
      <th>timestamp</th>
      <th>user_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>35627</th>
      <td>raw</td>
      <td>35627</td>
      <td>catalog</td>
      <td>2020-04-29 12:24:21</td>
      <td>831491833</td>
    </tr>
    <tr>
      <th>35628</th>
      <td>raw</td>
      <td>35628</td>
      <td>catalog</td>
      <td>2020-04-29 12:24:33</td>
      <td>831491833</td>
    </tr>
    <tr>
      <th>35629</th>
      <td>raw</td>
      <td>35629</td>
      <td>product2</td>
      <td>2020-04-29 12:24:39</td>
      <td>831491833</td>
    </tr>
    <tr>
      <th>35630</th>
      <td>raw</td>
      <td>35630</td>
      <td>cart</td>
      <td>2020-04-29 12:24:59</td>
      <td>831491833</td>
    </tr>
    <tr>
      <th>35631</th>
      <td>raw</td>
      <td>35631</td>
      <td>catalog</td>
      <td>2020-04-29 12:25:06</td>
      <td>831491833</td>
    </tr>
    <tr>
      <th>35632</th>
      <td>truncated_right</td>
      <td>35632</td>
      <td>truncated_right</td>
      <td>2020-04-29 12:25:06</td>
      <td>831491833</td>
    </tr>
  </tbody>
</table>
</div></section>
<section id="synthetic-events-order">
<h4>Synthetic events order<a class="headerlink" href="#synthetic-events-order" title="Permalink to this heading">#</a></h4>
<p>As you may have noticed, each synthetic event has a “parent” that
defines the timestamp. When you apply
multiple data processors, a timestamp collisions might occur, so it is not
clear how the events should be ordered. For colliding events,
the following sorting order is applied, based on event types(earlier event types
are added earlier):</p>
<ul class="simple">
<li><p>profile</p></li>
<li><p>path_start</p></li>
<li><p>new_user</p></li>
<li><p>existing_user</p></li>
<li><p>truncated_left</p></li>
<li><p>session_start</p></li>
<li><p>session_start_truncated</p></li>
<li><p>group_alias</p></li>
<li><p>raw</p></li>
<li><p>raw_sleep</p></li>
<li><p>None</p></li>
<li><p>synthetic</p></li>
<li><p>synthetic_sleep</p></li>
<li><p>positive_target</p></li>
<li><p>negative_target</p></li>
<li><p>session_end_truncated</p></li>
<li><p>session_end</p></li>
<li><p>session_sleep</p></li>
<li><p>truncated_right</p></li>
<li><p>absent_user</p></li>
<li><p>lost_user</p></li>
<li><p>path_end</p></li>
</ul>
</section>
</section>
<section id="removing-processors">
<h3>Removing processors<a class="headerlink" href="#removing-processors" title="Permalink to this heading">#</a></h3>
<section id="filterevents">
<h4>FilterEvents<a class="headerlink" href="#filterevents" title="Permalink to this heading">#</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">FilterEvents</span></code> keeps events based on the masking function <code class="docutils literal notranslate"><span class="pre">func</span></code>.
The function should return a boolean mask for the input dataframe - that
is, a series of boolean <code class="docutils literal notranslate"><span class="pre">True</span> <span class="pre">or</span> <span class="pre">False</span></code> variables, that is used
as a filter for the dataframe underlying the eventstream.</p>
<figure class="align-default">
<img alt="../_images/dp_9_filter.png" src="../_images/dp_9_filter.png" />
</figure>
<p>Let us say we are interested only in specific events - for example, only
in events of users that appear in some pre-defined list of users.
<code class="docutils literal notranslate"><span class="pre">FilterEvents</span></code> allows us to access only those events:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">save_specific_users</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
    <span class="n">users_to_save</span> <span class="o">=</span> <span class="p">[</span><span class="mi">219483890</span><span class="p">,</span> <span class="mi">964964743</span><span class="p">,</span> <span class="mi">965024600</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">schema</span><span class="o">.</span><span class="n">user_id</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">users_to_save</span><span class="p">)</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">save_specific_users</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
</pre></div>
</div>
<p>The resulting eventstream includes these 3 users only:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([</span><span class="mi">219483890</span><span class="p">,</span> <span class="mi">964964743</span><span class="p">,</span> <span class="mi">965024600</span><span class="p">])</span>
</pre></div>
</div>
<p>Note that the masking function accepts not just <code class="docutils literal notranslate"><span class="pre">pandas.DataFrame</span></code>
associated with the eventstream, but <code class="docutils literal notranslate"><span class="pre">schema</span></code> parameter as well.
Having this parameter, you can access any eventstream column,
defined in its <a class="reference internal" href="../api/eventstream/eventstream_core.html#retentioneering.eventstream.schema.EventstreamSchema" title="retentioneering.eventstream.schema.EventstreamSchema"><code class="xref py py-meth docutils literal notranslate"><span class="pre">EventstreamSchema</span></code></a></p>
<p>This makes such masking functions reusable regardless of eventstream
column titles.</p>
<p>Using <code class="docutils literal notranslate"><span class="pre">FilterEvents</span></code> data processor, we can
also remove specific events from the eventstream. Let us remove all
<code class="docutils literal notranslate"><span class="pre">catalog</span></code> and <code class="docutils literal notranslate"><span class="pre">main</span></code> events, assuming they are non-informative for
us:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>\
    <span class="p">[</span><span class="s1">&#39;event&#39;</span><span class="p">]</span>\
    <span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>\
    <span class="p">[</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;catalog&#39;</span><span class="p">,</span> <span class="s1">&#39;main&#39;</span><span class="p">])]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">catalog</span>    <span class="mi">14518</span>
<span class="n">main</span>        <span class="mi">5635</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">event</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">exclude_events</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
    <span class="n">events_to_exclude</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;catalog&#39;</span><span class="p">,</span> <span class="s1">&#39;main&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="n">schema</span><span class="o">.</span><span class="n">event_name</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">events_to_exclude</span><span class="p">)</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">exclude_events</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
</pre></div>
</div>
<p>We can see that <code class="docutils literal notranslate"><span class="pre">res</span></code> dataframe does not have “useless” events anymore.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;event&#39;</span><span class="p">]</span>\
    <span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>\
    <span class="p">[</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;catalog&#39;</span><span class="p">,</span> <span class="s1">&#39;main&#39;</span><span class="p">])]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Series</span><span class="p">([],</span> <span class="n">Name</span><span class="p">:</span> <span class="n">event</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="deleteusersbypathlength">
<h4>DeleteUsersByPathLength<a class="headerlink" href="#deleteusersbypathlength" title="Permalink to this heading">#</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">DeleteUsersByPathLength</span></code> removes the paths
which we consider “too short”. We might be interested in excluding such paths -
in case they are too short to be informative for our task.</p>
<p>Path length can be specified in the following ways:</p>
<ul class="simple">
<li><p>specifying the number of events comprising a path,</p></li>
<li><p>specifying the time distance between the beginning and the end of a path.</p></li>
</ul>
<p>The former is associated with <code class="docutils literal notranslate"><span class="pre">events_num</span></code> parameter, the latter –
with <code class="docutils literal notranslate"><span class="pre">cutoff</span></code> parameter. Thus, <code class="docutils literal notranslate"><span class="pre">DeleteUsersByPathLength</span></code> removes all
the paths of length less than <code class="docutils literal notranslate"><span class="pre">events_num</span></code> or <code class="docutils literal notranslate"><span class="pre">cutoff</span></code>.</p>
<p>Diagram for specified <code class="docutils literal notranslate"><span class="pre">events_num</span></code>:</p>
<figure class="align-default">
<img alt="../_images/dp_10_delete_events.png" src="../_images/dp_10_delete_events.png" />
</figure>
<p>Diagram for specified <code class="docutils literal notranslate"><span class="pre">cutoff</span></code>:</p>
<figure class="align-default">
<img alt="../_images/dp_10_delete_cutoff.png" src="../_images/dp_10_delete_cutoff.png" />
</figure>
<p>Let us showcase both variants of the <code class="docutils literal notranslate"><span class="pre">DeleteUsersByPathLength</span></code>
dataprocessor:</p>
<p>A minimum number of events specified:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">delete_users</span><span class="p">(</span><span class="n">events_num</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
</pre></div>
</div>
<p>Any remaining user has at least 25 events. For example, user
<code class="docutils literal notranslate"><span class="pre">629881394</span></code> has 48 events.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">629881394</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">48</span>
</pre></div>
</div>
<p>A minimum path length (user lifetime) specified:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">delete_users</span><span class="p">(</span><span class="n">cutoff</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
</pre></div>
</div>
<p>Any remaining user has been “alive” for at least a full month. For
example, user <code class="docutils literal notranslate"><span class="pre">964964743</span></code> started her trajectory on <code class="docutils literal notranslate"><span class="pre">2019-11-01</span></code> and
ended on <code class="docutils literal notranslate"><span class="pre">2019-12-09</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">964964743</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_type</th>
      <th>event_index</th>
      <th>event</th>
      <th>timestamp</th>
      <th>user_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>4</th>
      <td>raw</td>
      <td>4</td>
      <td>catalog</td>
      <td>2019-11-01 21:38:19</td>
      <td>964964743</td>
    </tr>
    <tr>
      <th>3457</th>
      <td>raw</td>
      <td>3457</td>
      <td>delivery_pickup</td>
      <td>2019-12-09 01:43:57</td>
      <td>964964743</td>
    </tr>
  </tbody>
</table>
</div></section>
<section id="truncatepath">
<h4>TruncatePath<a class="headerlink" href="#truncatepath" title="Permalink to this heading">#</a></h4>
<p>For each user trajectory, <code class="docutils literal notranslate"><span class="pre">TruncatePath</span></code> drops all events either before
or after a certain event. The following parameters specify the
behavior:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">drop_before</span></code>: event name before which part of the user’s path is
dropped. Specified event remains in the eventstream.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">drop_after</span></code>: event name after which part of the user’s path is
dropped. Specified event remains in the eventstream.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">occurrence_before</span></code>: if set to <code class="docutils literal notranslate"><span class="pre">first</span></code> (by default), all events
before the first occurrence of the <code class="docutils literal notranslate"><span class="pre">drop_before</span></code> event are dropped.
If set to <code class="docutils literal notranslate"><span class="pre">last</span></code>, all events before the last occurrence of the
<code class="docutils literal notranslate"><span class="pre">drop_before</span></code> event are dropped.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">occurrence_after</span></code>: the same behavior as in the
<code class="docutils literal notranslate"><span class="pre">occurrence_before</span></code>, but for right (after the event) path
truncation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">shift_before</span></code>: sets the number of steps by which the truncate
point is shifted from the selected event. If the value is negative,
then the offset occurs to the left along the timeline; if positive,
then the offset occurs to the right.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">shift_after</span></code>: the same behavior as in the shift_before, but for
right (after the event) path truncation.</p></li>
</ul>
<p>If the specified event is not present in a user path, the path remains
unchanged.</p>
<figure class="align-default">
<img alt="../_images/dp_11_truncate_path.png" src="../_images/dp_11_truncate_path.png" />
</figure>
<p>Suppose we want to see what happens to the user after she jumps to a
<code class="docutils literal notranslate"><span class="pre">cart</span></code> event. Suppose also that we need to find out which events
preceded the <code class="docutils literal notranslate"><span class="pre">cart</span></code> event. To do this, we can use <code class="docutils literal notranslate"><span class="pre">TruncatePath</span></code> with specified
<code class="docutils literal notranslate"><span class="pre">drop_before='cart'</span></code> and <code class="docutils literal notranslate"><span class="pre">shift_before=-2</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">truncate_path</span><span class="p">(</span><span class="n">drop_before</span><span class="o">=</span><span class="s1">&#39;cart&#39;</span><span class="p">,</span> <span class="n">shift_before</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
</pre></div>
</div>
<p>Now some users have their trajectories truncated, because they had at
least one <code class="docutils literal notranslate"><span class="pre">cart</span></code> in their path:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">219483890</span><span class="p">]</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_type</th>
      <th>event_index</th>
      <th>event</th>
      <th>timestamp</th>
      <th>user_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>raw</td>
      <td>0</td>
      <td>catalog</td>
      <td>2019-11-01 17:59:13</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>1</th>
      <td>raw</td>
      <td>1</td>
      <td>product1</td>
      <td>2019-11-01 17:59:28</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>2</th>
      <td>raw</td>
      <td>2</td>
      <td>cart</td>
      <td>2019-11-01 17:59:29</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>3</th>
      <td>raw</td>
      <td>3</td>
      <td>catalog</td>
      <td>2019-11-01 17:59:32</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>10317</th>
      <td>raw</td>
      <td>10317</td>
      <td>catalog</td>
      <td>2020-02-14 21:04:51</td>
      <td>219483890</td>
    </tr>
  </tbody>
</table>
</div><p>As we can see, this path now starts with the two events preceding
<code class="docutils literal notranslate"><span class="pre">cart</span></code> (<code class="docutils literal notranslate"><span class="pre">event_index</span> <span class="pre">=</span> <span class="pre">0,</span> <span class="pre">1</span></code>), and <code class="docutils literal notranslate"><span class="pre">cart</span></code> right after them
<code class="docutils literal notranslate"><span class="pre">event_index</span> <span class="pre">=</span> <span class="pre">2</span></code>. Another <code class="docutils literal notranslate"><span class="pre">cart</span></code> event occurred here
(<code class="docutils literal notranslate"><span class="pre">event_index</span> <span class="pre">=</span> <span class="pre">5827</span></code>), but since the default
<code class="docutils literal notranslate"><span class="pre">occurrence_before='first'</span></code> was triggered, this second <code class="docutils literal notranslate"><span class="pre">cart</span></code> was
ignored by the data processor.</p>
<p>Some users do not have any <code class="docutils literal notranslate"><span class="pre">cart</span></code> events - and their
trajectories have not been changed:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">24427596</span><span class="p">]</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_type</th>
      <th>event_index</th>
      <th>event</th>
      <th>timestamp</th>
      <th>user_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>89</th>
      <td>raw</td>
      <td>89</td>
      <td>main</td>
      <td>2019-11-02 07:28:07</td>
      <td>24427596</td>
    </tr>
    <tr>
      <th>90</th>
      <td>raw</td>
      <td>90</td>
      <td>catalog</td>
      <td>2019-11-02 07:28:14</td>
      <td>24427596</td>
    </tr>
    <tr>
      <th>91</th>
      <td>raw</td>
      <td>91</td>
      <td>catalog</td>
      <td>2019-11-02 07:29:08</td>
      <td>24427596</td>
    </tr>
    <tr>
      <th>92</th>
      <td>raw</td>
      <td>92</td>
      <td>catalog</td>
      <td>2019-11-02 07:29:41</td>
      <td>24427596</td>
    </tr>
  </tbody>
</table>
</div><p>We can also perform truncation from the right, or specify for truncation
point to be not the first, but the last occurrence of <code class="docutils literal notranslate"><span class="pre">cart</span></code>. To
demonstrate both, let us set <code class="docutils literal notranslate"><span class="pre">drop_after</span> <span class="pre">=</span> <span class="pre">&quot;cart&quot;</span></code> and
<code class="docutils literal notranslate"><span class="pre">occurrence_after</span> <span class="pre">=</span> <span class="pre">&quot;last&quot;</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">truncate_path</span><span class="p">(</span><span class="n">drop_after</span><span class="o">=</span><span class="s1">&#39;cart&#39;</span><span class="p">,</span> <span class="n">occurrence_after</span><span class="o">=</span><span class="s2">&quot;last&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
</pre></div>
</div>
<p>Now, any trajectory which includes <code class="docutils literal notranslate"><span class="pre">cart</span></code> is truncated to end with the
last <code class="docutils literal notranslate"><span class="pre">cart</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">219483890</span><span class="p">]</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_type</th>
      <th>event_index</th>
      <th>event</th>
      <th>timestamp</th>
      <th>user_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>raw</td>
      <td>0</td>
      <td>catalog</td>
      <td>2019-11-01 17:59:13</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>1</th>
      <td>raw</td>
      <td>1</td>
      <td>product1</td>
      <td>2019-11-01 17:59:28</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>2</th>
      <td>raw</td>
      <td>2</td>
      <td>cart</td>
      <td>2019-11-01 17:59:29</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>5639</th>
      <td>raw</td>
      <td>5639</td>
      <td>catalog</td>
      <td>2020-01-06 22:10:15</td>
      <td>219483890</td>
    </tr>
    <tr>
      <th>5640</th>
      <td>raw</td>
      <td>5640</td>
      <td>cart</td>
      <td>2020-01-06 22:10:42</td>
      <td>219483890</td>
    </tr>
  </tbody>
</table>
</div></section>
</section>
<section id="editing-processors">
<h3>Editing processors<a class="headerlink" href="#editing-processors" title="Permalink to this heading">#</a></h3>
<section id="groupevents">
<h4>GroupEvents<a class="headerlink" href="#groupevents" title="Permalink to this heading">#</a></h4>
<p>Given a masking function passed as <code class="docutils literal notranslate"><span class="pre">func</span></code>, <code class="docutils literal notranslate"><span class="pre">GroupEvents</span></code> replaces
all the events marked by <code class="docutils literal notranslate"><span class="pre">func</span></code> with newly created synthetic events
of <code class="docutils literal notranslate"><span class="pre">event_name</span></code> name and <code class="docutils literal notranslate"><span class="pre">event_type</span></code> type (<code class="docutils literal notranslate"><span class="pre">group_alias</span></code> by
default). The timestamps of these synthetic events are the same as their
parents’ ones. <code class="docutils literal notranslate"><span class="pre">func</span></code> can be any function that returns a series of
boolean (<code class="docutils literal notranslate"><span class="pre">True/False</span></code>) variables that can be used as a filter for the
dataframe underlying the eventstream.</p>
<p><span class="red">TODO: Replace ‘filter’ with ‘func’ on the diagram. dpanina</span></p>
<figure class="align-default">
<img alt="../_images/dp_12_group.png" src="../_images/dp_12_group.png" />
</figure>
<p>With <code class="docutils literal notranslate"><span class="pre">GroupEvents</span></code>, we can group events based on event name. Suppose
we need to assign a common name <code class="docutils literal notranslate"><span class="pre">product</span></code> to events <code class="docutils literal notranslate"><span class="pre">product1</span></code> and
<code class="docutils literal notranslate"><span class="pre">product2</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">group_events</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
    <span class="n">events_to_group</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;product1&#39;</span><span class="p">,</span> <span class="s1">&#39;product2&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">schema</span><span class="o">.</span><span class="n">event_name</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">events_to_group</span><span class="p">)</span>

<span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;event_name&#39;</span><span class="p">:</span> <span class="s1">&#39;product&#39;</span><span class="p">,</span>
    <span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">group_events</span>
<span class="p">}</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
</pre></div>
</div>
<p>As we can see, user <code class="docutils literal notranslate"><span class="pre">456870964</span></code> now has a couple of <code class="docutils literal notranslate"><span class="pre">product</span></code> events
(<code class="docutils literal notranslate"><span class="pre">event_index</span> <span class="pre">=</span> <span class="pre">160,</span> <span class="pre">164</span></code>) with <code class="docutils literal notranslate"><span class="pre">event_type</span> <span class="pre">=</span> <span class="pre">‘group_alias’</span></code>).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">456870964</span><span class="p">]</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_type</th>
      <th>event_index</th>
      <th>event</th>
      <th>timestamp</th>
      <th>user_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>157</th>
      <td>raw</td>
      <td>157</td>
      <td>catalog</td>
      <td>2019-11-03 11:46:55</td>
      <td>456870964</td>
    </tr>
    <tr>
      <th>158</th>
      <td>raw</td>
      <td>158</td>
      <td>catalog</td>
      <td>2019-11-03 11:47:46</td>
      <td>456870964</td>
    </tr>
    <tr>
      <th>159</th>
      <td>raw</td>
      <td>159</td>
      <td>catalog</td>
      <td>2019-11-03 11:47:58</td>
      <td>456870964</td>
    </tr>
    <tr>
      <th>160</th>
      <td>group_alias</td>
      <td>160</td>
      <td>product</td>
      <td>2019-11-03 11:48:43</td>
      <td>456870964</td>
    </tr>
    <tr>
      <th>162</th>
      <td>raw</td>
      <td>162</td>
      <td>cart</td>
      <td>2019-11-03 11:49:17</td>
      <td>456870964</td>
    </tr>
    <tr>
      <th>163</th>
      <td>raw</td>
      <td>163</td>
      <td>catalog</td>
      <td>2019-11-03 11:49:17</td>
      <td>456870964</td>
    </tr>
    <tr>
      <th>164</th>
      <td>group_alias</td>
      <td>164</td>
      <td>product</td>
      <td>2019-11-03 11:49:28</td>
      <td>456870964</td>
    </tr>
    <tr>
      <th>166</th>
      <td>raw</td>
      <td>166</td>
      <td>catalog</td>
      <td>2019-11-03 11:49:30</td>
      <td>456870964</td>
    </tr>
  </tbody>
</table>
</div><p>Previously, both events were named
<code class="docutils literal notranslate"><span class="pre">product1</span></code> and <code class="docutils literal notranslate"><span class="pre">product2</span></code> and had <code class="docutils literal notranslate"><span class="pre">raw</span></code> event type:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;user_id == 456870964&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_type</th>
      <th>event_index</th>
      <th>event</th>
      <th>timestamp</th>
      <th>user_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>140</th>
      <td>raw</td>
      <td>140</td>
      <td>catalog</td>
      <td>2019-11-03 11:46:55</td>
      <td>456870964</td>
    </tr>
    <tr>
      <th>141</th>
      <td>raw</td>
      <td>141</td>
      <td>catalog</td>
      <td>2019-11-03 11:47:46</td>
      <td>456870964</td>
    </tr>
    <tr>
      <th>142</th>
      <td>raw</td>
      <td>142</td>
      <td>catalog</td>
      <td>2019-11-03 11:47:58</td>
      <td>456870964</td>
    </tr>
    <tr>
      <th>143</th>
      <td>raw</td>
      <td>143</td>
      <td>product1</td>
      <td>2019-11-03 11:48:43</td>
      <td>456870964</td>
    </tr>
    <tr>
      <th>144</th>
      <td>raw</td>
      <td>144</td>
      <td>cart</td>
      <td>2019-11-03 11:49:17</td>
      <td>456870964</td>
    </tr>
    <tr>
      <th>145</th>
      <td>raw</td>
      <td>145</td>
      <td>catalog</td>
      <td>2019-11-03 11:49:17</td>
      <td>456870964</td>
    </tr>
    <tr>
      <th>146</th>
      <td>raw</td>
      <td>146</td>
      <td>product2</td>
      <td>2019-11-03 11:49:28</td>
      <td>456870964</td>
    </tr>
    <tr>
      <th>147</th>
      <td>raw</td>
      <td>147</td>
      <td>catalog</td>
      <td>2019-11-03 11:49:30</td>
      <td>456870964</td>
    </tr>
  </tbody>
</table>
</div><p>You can also notice that the newly created <code class="docutils literal notranslate"><span class="pre">product</span></code> events have
<code class="docutils literal notranslate"><span class="pre">event_id</span></code> that differs from their parents’ event_ids.</p>
</section>
<section id="collapseloops">
<h4>CollapseLoops<a class="headerlink" href="#collapseloops" title="Permalink to this heading">#</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">CollapseLoops</span></code> replaces all uninterrupted series of repetitive user
events (loops) with one new <code class="docutils literal notranslate"><span class="pre">loop</span></code>-like event. The name of the
new event is defined by the suffix parameter:</p>
<ul class="simple">
<li><p>given <code class="docutils literal notranslate"><span class="pre">suffix=None</span></code>, names new event with the old event_name, i.e. passes along
the name of the repeating event;</p></li>
<li><p>given <code class="docutils literal notranslate"><span class="pre">suffix=&quot;loop&quot;</span></code>, names new event <code class="docutils literal notranslate"><span class="pre">event_name_loop</span></code>;</p></li>
<li><p>given <code class="docutils literal notranslate"><span class="pre">suffix=&quot;count&quot;</span></code>, names new event
<code class="docutils literal notranslate"><span class="pre">event_name_loop_{number</span> <span class="pre">of</span> <span class="pre">event</span> <span class="pre">repetitions}</span></code>.</p></li>
</ul>
<p>The timestamp that the new event has is determined by
<code class="docutils literal notranslate"><span class="pre">timestamp_aggregation_type</span></code> value:</p>
<ul class="simple">
<li><p>given <code class="docutils literal notranslate"><span class="pre">timestamp_aggregation_type=&quot;max&quot;</span></code> (the default option),
passes the timestamp of the last event from the loop;</p></li>
<li><p>given <code class="docutils literal notranslate"><span class="pre">timestamp_aggregation_type=&quot;min&quot;</span></code>, passes the timestamp of
the first event from the loop;</p></li>
<li><p>given <code class="docutils literal notranslate"><span class="pre">timestamp_aggregation_type=&quot;mean&quot;</span></code>, passes the average loop
timestamp.</p></li>
</ul>
<figure class="align-default">
<img alt="../_images/dp_13_collapse_loops.png" src="../_images/dp_13_collapse_loops.png" />
</figure>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">collapse_loops</span><span class="p">()</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
</pre></div>
</div>
<p>Consider for example user <code class="docutils literal notranslate"><span class="pre">2112338</span></code>. In the original eventstream she
had 3 consecutive <code class="docutils literal notranslate"><span class="pre">catalog</span></code> events.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;user_id == 2112338&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_type</th>
      <th>event_index</th>
      <th>event</th>
      <th>timestamp</th>
      <th>user_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3550</th>
      <td>raw</td>
      <td>3550</td>
      <td>main</td>
      <td>2019-12-24 12:58:04</td>
      <td>2112338</td>
    </tr>
    <tr>
      <th>3551</th>
      <td>raw</td>
      <td>3551</td>
      <td>catalog</td>
      <td>2019-12-24 12:58:08</td>
      <td>2112338</td>
    </tr>
    <tr>
      <th>3552</th>
      <td>raw</td>
      <td>3552</td>
      <td>catalog</td>
      <td>2019-12-24 12:58:16</td>
      <td>2112338</td>
    </tr>
    <tr>
      <th>3553</th>
      <td>raw</td>
      <td>3553</td>
      <td>catalog</td>
      <td>2019-12-24 12:58:44</td>
      <td>2112338</td>
    </tr>
    <tr>
      <th>3554</th>
      <td>raw</td>
      <td>3554</td>
      <td>main</td>
      <td>2019-12-24 12:58:52</td>
      <td>2112338</td>
    </tr>
  </tbody>
</table>
</div><p>In the resulting dataframe, the repeating “catalog” events have been collapsed to a single
<code class="docutils literal notranslate"><span class="pre">catalog_loop</span></code> event. The timestamp of this synthetic event is the
same as the timestamp of the last looping event:
<code class="docutils literal notranslate"><span class="pre">2019-12-24</span> <span class="pre">12:58:44</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2112338</span><span class="p">]</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_type</th>
      <th>event_index</th>
      <th>event</th>
      <th>timestamp</th>
      <th>user_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>5061</th>
      <td>raw</td>
      <td>5061</td>
      <td>main</td>
      <td>2019-12-24 12:58:04</td>
      <td>2112338</td>
    </tr>
    <tr>
      <th>5066</th>
      <td>group_alias</td>
      <td>5066</td>
      <td>catalog_loop</td>
      <td>2019-12-24 12:58:44</td>
      <td>2112338</td>
    </tr>
    <tr>
      <th>5069</th>
      <td>raw</td>
      <td>5069</td>
      <td>main</td>
      <td>2019-12-24 12:58:52</td>
      <td>2112338</td>
    </tr>
  </tbody>
</table>
</div><p>To see the length of the loops we removed, we can set suffix to
<code class="docutils literal notranslate"><span class="pre">count</span></code>. Also, let us see how <code class="docutils literal notranslate"><span class="pre">timestamp_aggregation_type</span></code> works if
we set it to <code class="docutils literal notranslate"><span class="pre">mean</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;suffix&#39;</span><span class="p">:</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span>
    <span class="s1">&#39;timestamp_aggregation_type&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span>
<span class="p">}</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">collapse_loops</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
<span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2112338</span><span class="p">]</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_type</th>
      <th>event_index</th>
      <th>event</th>
      <th>timestamp</th>
      <th>user_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>5071</th>
      <td>raw</td>
      <td>5071</td>
      <td>main</td>
      <td>2019-12-24 12:58:04</td>
      <td>2112338</td>
    </tr>
    <tr>
      <th>5076</th>
      <td>group_alias</td>
      <td>5076</td>
      <td>catalog_loop_3</td>
      <td>2019-12-24 12:58:23</td>
      <td>2112338</td>
    </tr>
    <tr>
      <th>5079</th>
      <td>raw</td>
      <td>5079</td>
      <td>main</td>
      <td>2019-12-24 12:58:52</td>
      <td>2112338</td>
    </tr>
  </tbody>
</table>
</div><p>Now, the synthetic <code class="docutils literal notranslate"><span class="pre">catalog_loop_3</span></code> event has <code class="docutils literal notranslate"><span class="pre">12:58:23</span></code> time - which is
the average of <code class="docutils literal notranslate"><span class="pre">12:58:08</span></code>, <code class="docutils literal notranslate"><span class="pre">12:58:16</span></code>, <code class="docutils literal notranslate"><span class="pre">12:58:44</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">CollapseLoops</span></code> dataprocessor can be useful for compressing the
data - by packing loop information into single events, - or removing
looping events, in case they are not desirable (which can be a common
case in clickstream visualization).</p>
</section>
</section>
</section>
<section id="custom-data-processors">
<h2>Custom data processors<a class="headerlink" href="#custom-data-processors" title="Permalink to this heading">#</a></h2>
<p>We have covered all data processors that currently exist in our
library.</p>
<p>You can create a custom dataprocessor, which could implement the data transformations you
often use. For details, please refer to our custom dataprocessors User Guide.</p>
<p><span class="red">TODO: Create UG and add link. dpanina</span></p>
</section>
<section id="advanced-usage-example">
<h2>Advanced usage example<a class="headerlink" href="#advanced-usage-example" title="Permalink to this heading">#</a></h2>
<p>Let us give an example of a processing graph that an analyst could use
to prepare the data for analysis or visualization. We are using the same
simple-onlineshop dataset we have seen before.</p>
<p>If we try to visualize the data without using dataprocessors, we can get
results that are difficult to analyze:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">retentioneering.transition_graph</span> <span class="kn">import</span> <span class="n">TransitionGraph</span>

<span class="n">tgraph</span> <span class="o">=</span> <span class="n">TransitionGraph</span><span class="p">(</span><span class="n">eventstream</span><span class="o">=</span><span class="n">stream</span><span class="p">,</span> <span class="n">graph_settings</span><span class="o">=</span><span class="p">{})</span>
<span class="n">tgraph</span><span class="o">.</span><span class="n">plot_graph</span><span class="p">(</span><span class="n">thresholds</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;nodes&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;edges&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span> <span class="n">targets</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<iframe
    width="700"
    height="600"
    src="../_static/user_guides/data_processor/transition_graph.html"
    frameborder="0"
    align="left"
    allowfullscreen
></iframe><p>Of course, by using the transition graph interactive
options, we could focus on specific event transitions. However, even the
general user workflow can be difficult to see - because of big amount of
ungrouped events, loops, and states.</p>
<p>We can address this problem by using a combination of dataprocessors we
have seen previously. One example of a processing graph would look like
this:</p>
<ul class="simple">
<li><p>apply <strong>DeleteUsersByPathLength</strong> to remove users that could have
appeared by accident;</p></li>
<li><p>apply <strong>StartEndEvents</strong> to mark the start and finish user states;</p></li>
<li><p>apply <strong>SplitSessions</strong> to mark user sessions;</p></li>
<li><p>apply <strong>GroupEvents</strong> multiple times to group similar events into
groups;</p></li>
<li><p>apply <strong>CollapseLoops</strong> with different parameters, for different loop
representation on the transition graph plot</p></li>
</ul>
<figure class="align-default">
<img alt="../_images/dp_14_pgraph_advanced.png" src="../_images/dp_14_pgraph_advanced.png" />
</figure>
<p>As the result, we should get three similar eventstreams that differ only
in their way of encoding loops. That is the main inherent advantage of
using the graph structure for transformations - we only need to execute
all common dataprocessors once, and then we can quickly alternate
between different “heads” of the transformation.</p>
<p>Let us compose this graph:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">group_browsing</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">schema</span><span class="o">.</span><span class="n">event_name</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;catalog&#39;</span><span class="p">,</span> <span class="s1">&#39;main&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">group_products</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">schema</span><span class="o">.</span><span class="n">event_name</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;product1&#39;</span><span class="p">,</span> <span class="s1">&#39;product2&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">group_delivery</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">schema</span><span class="o">.</span><span class="n">event_name</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;delivery_choice&#39;</span><span class="p">,</span> <span class="s1">&#39;delivery_courier&#39;</span><span class="p">,</span> <span class="s1">&#39;delivery_pickup&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">group_payment</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">schema</span><span class="o">.</span><span class="n">event_name</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;payment_choice&#39;</span><span class="p">,</span> <span class="s1">&#39;payment_done&#39;</span><span class="p">,</span> <span class="s1">&#39;payment_card&#39;</span><span class="p">,</span> <span class="s1">&#39;payment_cash&#39;</span><span class="p">])</span>


<span class="n">stream_7_nodes</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">delete_users</span><span class="p">(</span><span class="n">events_num</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>\
                        <span class="o">.</span><span class="n">add_start_end</span><span class="p">()</span>\
                        <span class="o">.</span><span class="n">split_sessions</span><span class="p">(</span><span class="n">session_cutoff</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">))</span>\
                        <span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">event_name</span><span class="o">=</span><span class="s1">&#39;browsing&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">group_browsing</span><span class="p">)</span>\
                        <span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">event_name</span><span class="o">=</span><span class="s1">&#39;delivery&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">group_delivery</span><span class="p">)</span>\
                        <span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">event_name</span><span class="o">=</span><span class="s1">&#39;payment&#39;</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">group_payment</span><span class="p">)</span>
</pre></div>
</div>
<p>Looking at the simpliest version, where loops are replaced with the
event they consist of:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stream_out</span> <span class="o">=</span> <span class="n">stream_7_nodes</span><span class="o">.</span><span class="n">collapse_loops</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">tgraph</span> <span class="o">=</span> <span class="n">TransitionGraph</span><span class="p">(</span><span class="n">eventstream</span><span class="o">=</span><span class="n">stream_out</span><span class="p">,</span> <span class="n">graph_settings</span><span class="o">=</span><span class="p">{})</span>
<span class="n">tgraph</span><span class="o">.</span><span class="n">plot_graph</span><span class="p">(</span><span class="n">thresholds</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;nodes&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;edges&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span> <span class="n">targets</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<iframe
    width="700"
    height="600"
    src="../_static/user_guides/data_processor/transition_graph_collapse_loops_none.html"
    frameborder="0"
    align="left"
    allowfullscreen
></iframe><p>This transition graph is much easier to look at. After applying the
dataprocessors, we can now see that:</p>
<ul class="simple">
<li><p>“lost” is a synthetic event marking an end of user trajectory, and
should be removed in the next graph version(to be fair, we could see
this in the first plot as well; however, details like this are very
easy to miss, and simplifying the resulting plot alleviates the
problem)</p></li>
<li><p>users start their sessions either by browsing(most users) or by going
to cart(small but noticeable share of users who probably spent over
30 minutes on product specifications)</p></li>
<li><p>after finishing a session, about 47.5% of users leave the website for
good</p></li>
<li><p>after transitioning from “cart” to “delivery”, about 30% of users do
not proceed to “payment”</p></li>
</ul>
<p>We can also see the general user flow quite clearly now, which is a huge
improvement compared to the original plot.</p>
<p>To learn more about loops and where they occur, let us plot two other
versions of the eventstream:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stream_out</span> <span class="o">=</span> <span class="n">stream_7_nodes</span><span class="o">.</span><span class="n">collapse_loops</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;loop&#39;</span><span class="p">)</span>
<span class="n">tgraph</span> <span class="o">=</span> <span class="n">TransitionGraph</span><span class="p">(</span><span class="n">eventstream</span><span class="o">=</span><span class="n">stream_out</span><span class="p">,</span> <span class="n">graph_settings</span><span class="o">=</span><span class="p">{})</span>
<span class="n">tgraph</span><span class="o">.</span><span class="n">plot_graph</span><span class="p">(</span><span class="n">thresholds</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;nodes&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;edges&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span> <span class="n">targets</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<iframe
    width="700"
    height="600"
    src="../_static/user_guides/data_processor/transition_graph_collapse_loops_loop.html"
    frameborder="0"
    align="left"
    allowfullscreen
></iframe><p>In this plot (which is a bit more convoluted than the previous one), we
see that loops mostly occur when users are browsing, and are less
frequent at the <code class="docutils literal notranslate"><span class="pre">delivery</span></code> or <code class="docutils literal notranslate"><span class="pre">payment</span> <span class="pre">stages</span></code>. However, there are a
lot more transitions to <code class="docutils literal notranslate"><span class="pre">payment_loop</span></code> or <code class="docutils literal notranslate"><span class="pre">delivery_loop</span></code> than there
are to <code class="docutils literal notranslate"><span class="pre">payment</span></code> or <code class="docutils literal notranslate"><span class="pre">delivery</span></code>!</p>
<p>This could suggest that there is a problem with the delivery/payment
process, or that we could improve the process by reducing the number of
transitions (i.e. “clicks”) it takes to make an order a delivery or to
pay.</p>
<p>Now we can attempt to look at the typical loop length using the third
created eventstream:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stream_out</span> <span class="o">=</span> <span class="n">stream_7_nodes</span><span class="o">.</span><span class="n">collapse_loops</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
<span class="n">tgraph</span> <span class="o">=</span> <span class="n">TransitionGraph</span><span class="p">(</span><span class="n">eventstream</span><span class="o">=</span><span class="n">stream_out</span><span class="p">,</span> <span class="n">graph_settings</span><span class="o">=</span><span class="p">{})</span>
<span class="n">tgraph</span><span class="o">.</span><span class="n">plot_graph</span><span class="p">(</span><span class="n">thresholds</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;nodes&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;edges&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span> <span class="n">targets</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
 <iframe
    width="700"
    height="600"
    src="../_static/user_guides/data_processor/transition_graph_collapse_loops_count.html"
    frameborder="0"
    align="left"
    allowfullscreen
></iframe><p>This plot is much more complex than the previous two; to properly
analyze it, we would need to filter out some loop events based on their
frequency. Still, we can see that the longest loops occur at the
browsing stage - and cart, payment, or delivery loops are limited by 2-3
steps, meaning that the problem we found might not be as critical as it
first appeared.</p>
</section>
</section>


            </article>
            
            
            
            <footer class="bd-footer-article">
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
  <a class='left-prev' id="prev-link" href="eventstream.html" title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
          <p class="prev-next-subtitle">previous</p>
          <p class="prev-next-title">Eventstream</p>
      </div>
  </a>
  <a class='right-next' id="next-link" href="preprocessing.html" title="next page">
  <div class="prev-next-info">
      <p class="prev-next-subtitle">next</p>
      <p class="prev-next-title">Preprocessing</p>
  </div>
  <i class="fa-solid fa-angle-right"></i>
  </a>
</div>
            </footer>
            
          </div>
          
          
          
            <div class="bd-sidebar-secondary bd-toc">
              
<div class="toc-item">
  
<div class="tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
</div>
<nav id="bd-toc-nav" class="page-toc">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#creating-an-eventstream">
   Creating an eventstream
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-is-a-dataprocessor">
   What is a DataProcessor?
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#general-usage">
   General usage
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#helpers-and-chain-usage">
   Helpers and chain usage
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-processors-library">
   Data Processors library
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#adding-processors">
     Adding processors
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#startendevents">
       StartEndEvents
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#splitsessions">
       SplitSessions
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#newusersevents">
       NewUsersEvents
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#lostusersevents">
       LostUsersEvents
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#positivetarget">
       PositiveTarget
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#negativetarget">
       NegativeTarget
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#truncatedevents">
       TruncatedEvents
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#synthetic-events-order">
       Synthetic events order
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#removing-processors">
     Removing processors
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#filterevents">
       FilterEvents
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#deleteusersbypathlength">
       DeleteUsersByPathLength
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#truncatepath">
       TruncatePath
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#editing-processors">
     Editing processors
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#groupevents">
       GroupEvents
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#collapseloops">
       CollapseLoops
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#custom-data-processors">
   Custom data processors
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#advanced-usage-example">
   Advanced usage example
  </a>
 </li>
</ul>

</nav>
</div>

<div class="toc-item">
  
<div id="searchbox"></div>
</div>

<div class="toc-item">
  
</div>

<div class="toc-item">
  
<div class="tocsection sourcelink">
    <a href="../_sources/user_guides/dataprocessors.rst.txt">
        <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
</div>

</div>

            </div>
          
          
        </div>
        <footer class="bd-footer-content">
          <div class="bd-footer-content__inner">
            
          </div>
        </footer>
        
      </main>
    </div>
  </div>

  
    
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94"></script>

 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>

  </body>
</html>