<!-- This template is needed for a toggling solution -->
<!-- https://stackoverflow.com/questions/2454577/sphinx-restructuredtext-show-hide-code-snippets -->

<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>StepMatrix &#8212; Retentioneering 3.0.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../_static/styles/bootstrap.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=796348d33e8b1d947c94" rel="stylesheet">
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2">
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2">
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94">
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/js/custom.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/clipboard@1/dist/clipboard.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'user_guides/step_matrix';</script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="StepSankey" href="step_sankey.html" />
    <link rel="prev" title="Transition Graph" href="transition_graph.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="light">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>

  
  <input type="checkbox" class="sidebar-toggle" name="__primary" id="__primary">
  <label class="overlay overlay-primary" for="__primary"></label>

  
  <input type="checkbox" class="sidebar-toggle" name="__secondary" id="__secondary">
  <label class="overlay overlay-secondary" for="__secondary"></label>

  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
      
<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  </div>

  
  <nav class="bd-header navbar navbar-expand-lg bd-navbar" id="navbar-main"><div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
      <span class="fa-solid fa-bars"></span>
  </label>
  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../index.html">

  
  
  
  
  
  
  

  
    <img src="../_static/rete_logo.svg" class="logo__image only-light" alt="Logo image">
    <img src="../_static/rete_logo_white.svg" class="logo__image only-dark" alt="Logo image">
  
  
</a>
    
  </div>

  
  <div class="col-lg-9 navbar-header-items">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../getting_started.html">
                        Getting Started
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../user_guide.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../tutorials.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../datasets.html">
                        Datasets
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../api_reference.html">
                        API Reference
                      </a>
                    </li>
                
    </ul>
</nav>
      </div>
      
    </div>

    <div id="navbar-end">
      
        <div class="navbar-end-item navbar-persistent--container">
          
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
        </div>
      
      
      <div class="navbar-end-item">
        <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>


  
  
    <div class="navbar-persistent--mobile">
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
    </div>
  

  
  <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
  </label>
  

</div>
  </nav>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        
  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../getting_started.html">
                        Getting Started
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../user_guide.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../tutorials.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../datasets.html">
                        Datasets
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../api_reference.html">
                        API Reference
                      </a>
                    </li>
                
    </ul>
</nav>
      </div>
      
      </div>
    

    
    
    <div class="sidebar-header-items__end">
      
      <div class="navbar-end-item">
        <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
    
  </div>

  
  <div class="sidebar-start-items sidebar-primary__section">
    <div class="sidebar-start-items__item"><nav class="bd-links" id="bd-docs-nav" aria-label="Section navigation">
  <p class="bd-links__title" role="heading" aria-level="1">
    Section Navigation
  </p>
  <div class="bd-toc-item navbar-nav">
    <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="eventstream.html"> Eventstream</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="dataprocessors.html"> DataProcessors</a></li>
<li class="toctree-l1"><a class="reference internal" href="preprocessing.html"> Preprocessing</a></li>
</ul>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="transition_graph.html"> Transition Graph</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#"> Step Matrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="step_sankey.html"> Step Sankey</a></li>
<li class="toctree-l1"><a class="reference internal" href="clusters.html"> Clusters</a></li>
<li class="toctree-l1"><a class="reference internal" href="funnel.html"> Funnels</a></li>
<li class="toctree-l1"><a class="reference internal" href="cohorts.html"> Cohorts</a></li>
<li class="toctree-l1"><a class="reference internal" href="stattests.html"> Stattests</a></li>
</ul>

  </div>
</nav>
    </div>
  </div>
  

  
  <div class="sidebar-end-items sidebar-primary__section">
    <div class="sidebar-end-items__item">
    </div>
  </div>

  
  <div id="rtd-footer-container"></div>

      </div>
      <main id="main-content" class="bd-main">
        
        
        <div class="bd-content">
          <div class="bd-article-container">
            
            <div class="bd-header-article">
                
            </div>
            
            
            <article class="bd-article" role="main">
              
  <section id="stepmatrix">
<h1>StepMatrix<a class="headerlink" href="#stepmatrix" title="Permalink to this heading">#</a></h1>
<p>The following user guide is also available as
<a class="reference external" href="https://colab.research.google.com/drive/12l603hupPLIWp9H1ljkr5RUQLuunbLY3?usp=share_link">Google Colab notebook</a>.</p>
<section id="step-matrix-definition">
<h2>Step matrix definition<a class="headerlink" href="#step-matrix-definition" title="Permalink to this heading">#</a></h2>
<p>Step matrix is a powerful tool in the retentioneering arsenal. It allows
getting a quick high-level understanding of user behavior. Step matrix
has powerful customization options to tailor the output depending on the
goal of the analysis.</p>
<p>To better understand how step matrix works let’s first consider an
intuitive example. Suppose we are analyze web-store logs and have a
dataset with event logs from four user sessions with the following
events in the following order:</p>
<img alt="../_images/step_matrix_demo.png" src="../_images/step_matrix_demo.png" />
<p>We can visualize this dataset as a step-wise heatmap indicating the
distribution of the events appeared at a specific step:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">retentioneering.eventstream</span> <span class="kn">import</span> <span class="n">Eventstream</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">simple_example</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;user1&#39;</span><span class="p">,</span> <span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;user2&#39;</span><span class="p">,</span> <span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;user3&#39;</span><span class="p">,</span> <span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;user4&#39;</span><span class="p">,</span> <span class="s1">&#39;catalog&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;user1&#39;</span><span class="p">,</span> <span class="s1">&#39;catalog&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;user3&#39;</span><span class="p">,</span> <span class="s1">&#39;catalog&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;user4&#39;</span><span class="p">,</span> <span class="s1">&#39;product&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;user1&#39;</span><span class="p">,</span> <span class="s1">&#39;product&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;user3&#39;</span><span class="p">,</span> <span class="s1">&#39;catalog&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;user4&#39;</span><span class="p">,</span> <span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;user1&#39;</span><span class="p">,</span> <span class="s1">&#39;cart&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;user3&#39;</span><span class="p">,</span> <span class="s1">&#39;product&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;user4&#39;</span><span class="p">,</span> <span class="s1">&#39;catalog&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;user1&#39;</span><span class="p">,</span> <span class="s1">&#39;catalog&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;user3&#39;</span><span class="p">,</span> <span class="s1">&#39;cart&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;user3&#39;</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;event&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
<span class="p">)</span>


<span class="n">Eventstream</span><span class="p">(</span><span class="n">simple_example</span><span class="p">)</span><span class="o">.</span><span class="n">step_matrix</span><span class="p">(</span><span class="n">max_steps</span><span class="o">=</span><span class="mi">7</span><span class="p">);</span>
</pre></div>
</div>
<img alt="../_images/output_6_1.png" src="../_images/output_6_1.png" />
<p>This is the simplest step matrix. The matrix rows correspond to the
unique events, and the columns correspond to the steps in the user
trajectories. So that <code class="docutils literal notranslate"><span class="pre">(i,</span> <span class="pre">j)</span></code> matrix element show the percantage of
the users who had event <code class="docutils literal notranslate"><span class="pre">i</span></code> appeared at step <code class="docutils literal notranslate"><span class="pre">j</span></code>.</p>
<p>Below we will explore how to plot and customize the step matrix.</p>
<section id="loading-data">
<h3>Loading data<a class="headerlink" href="#loading-data" title="Permalink to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">retentioneering</span> <span class="kn">import</span> <span class="n">datasets</span>

<span class="n">stream</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">load_simple_shop</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="basic-example">
<h2>Basic example<a class="headerlink" href="#basic-example" title="Permalink to this heading">#</a></h2>
<p>StepMatrix tool is mainly available as <code class="docutils literal notranslate"><span class="pre">Eventstream.step_matrix()</span></code>
method. Here’s how it visualizes <code class="docutils literal notranslate"><span class="pre">simple_shop</span></code> eventstream:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span><span class="o">.</span><span class="n">step_matrix</span><span class="p">(</span><span class="n">max_steps</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_12_2.png" src="../_images/output_12_2.png" />
<p>As you can see, the sum of the values in the cells of the matrix at each
step is 1. Looking at the first column we can immediately say that the
users in the analyzed eventstream start their sessions from events
<code class="docutils literal notranslate"><span class="pre">catalog</span></code> (72%) and <code class="docutils literal notranslate"><span class="pre">main</span></code> (28%). We are potentially interested in
the payment_done event, and the step matrix shows that it appears in the
trajectories no earlier than the seventh step (row payment_done have
0.02 at step 7).</p>
</section>
<section id="terminating-event">
<h2>Terminating event<a class="headerlink" href="#terminating-event" title="Permalink to this heading">#</a></h2>
<p>As you may know, <code class="docutils literal notranslate"><span class="pre">ENDED</span></code> is a special synthetic event which explicitly
indicates a trajectory’s end. If a user’s path is shorter than
<code class="docutils literal notranslate"><span class="pre">max_steps</span></code> parameter, <code class="docutils literal notranslate"><span class="pre">path_end</span></code> is padded the path so that it
becomes exactly of length <code class="docutils literal notranslate"><span class="pre">max_steps</span></code>. Having this behavior
implemented, we can guarantee that the sum of the user fractions over
each column (i.e each step) is exactly 1. <code class="docutils literal notranslate"><span class="pre">ENDED</span></code> is always placed to
the bottom. This line calculates the cumulative share of users who left
the clickstream at each step.</p>
</section>
<section id="collapsing-rare-events">
<h2>Collapsing rare events<a class="headerlink" href="#collapsing-rare-events" title="Permalink to this heading">#</a></h2>
<p>Often we need to collapse rare events in the step matrix since these
events make it excessively noisy. This behaviour is controlled by
<code class="docutils literal notranslate"><span class="pre">thresh</span></code> argument. An event is considered as rare if its maximum
frequency over all the steps represented in the diagram is less than
<code class="docutils literal notranslate"><span class="pre">thresh</span></code>. All these rare events are not removed from the matrix, but
collapsed to <code class="docutils literal notranslate"><span class="pre">thresholded_N</span></code> artificial event instead where <code class="docutils literal notranslate"><span class="pre">N</span></code>
stands for the number of the collapsed events. <code class="docutils literal notranslate"><span class="pre">thresholded_N</span></code> event
appears in the step matrix only and is not added to the parent
eventstream.</p>
<p>Let’s look how the events are adsorbed if we set <code class="docutils literal notranslate"><span class="pre">thresh=0.05</span></code> and
compare the result with the previous step matrix (with default
<code class="docutils literal notranslate"><span class="pre">thresh=0</span></code> parameter).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span><span class="o">.</span><span class="n">step_matrix</span><span class="p">(</span><span class="n">max_steps</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">0.05</span><span class="p">);</span>
</pre></div>
</div>
<img alt="../_images/output_16_1.png" src="../_images/output_16_1.png" />
<p>All the rare events cutted away by thresholding are grouped
together in <code class="docutils literal notranslate"><span class="pre">THRESHOLDED_N</span></code> row, where N - is the total number of
dropped events. We see that thresholded_6 contains delivery_courier,
delivery_pickup, payment_cash, payment_card, payment_done,
payment_choice. Look at the <code class="docutils literal notranslate"><span class="pre">payment_choice</span></code> event in the previous
step matrix: at step 5 this event contains 3% of the users, 4% at step
6, and 3% at step 7. Since the maximum value (3%) is less than
thresh=0.05, the event is collapsed.</p>
<p>Please also note that the number _6 in the thresholded_6 event name
carries no information on a specific step. For example, from the matrix
with thresh=0 we see that at step 4 only one event among these 6 is
represented (delivery_courier), so it is the only event which is
collapsed at this step. On the other hand, at step 5 delivery_pickup and
payment_choice appear, so they are collapsed to thresholded_6 event.
Finally, at step 7 all these 6 events are collapsed.</p>
<p>It you want to prevent some events from the collapsing, use target
parameter then.</p>
</section>
<section id="targets-analysis">
<h2>Targets analysis<a class="headerlink" href="#targets-analysis" title="Permalink to this heading">#</a></h2>
<p>In product analysis we often deal with the events of particular
importance. This includes events such as adding an item to the cart,
order confirmation, payment, etc.. Such events have much lower
occurrence rate comparing with other events (like visiting main page or
catalog) and because of this are lost as collapsed to <code class="docutils literal notranslate"><span class="pre">THRESHOLDED_N</span></code>
or shown with non-informative coloring. In this case we can isolate
those events (targets) to individual rows, each of which will have their
individual color scale. This can be done with parameter <code class="docutils literal notranslate"><span class="pre">targets</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span><span class="o">.</span><span class="n">step_matrix</span><span class="p">(</span>
    <span class="n">max_steps</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">thresh</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;payment_done&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_20_2.png" src="../_images/output_20_2.png" />
<p>Specified target events are always shown in the bottom of step matrix
regardless of selected threshold. As we chose the <code class="docutils literal notranslate"><span class="pre">payment_done</span></code> event
as a target, the row with <code class="docutils literal notranslate"><span class="pre">payment_done</span></code> moved to the end of the
matrix and now has its own palette.</p>
<p>Multiple targets can be included as a list:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span><span class="o">.</span><span class="n">step_matrix</span><span class="p">(</span>
    <span class="n">max_steps</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">thresh</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;product1&#39;</span><span class="p">,</span> <span class="s1">&#39;cart&#39;</span><span class="p">,</span> <span class="s1">&#39;payment_done&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_22_2.png" src="../_images/output_22_2.png" />
<p>Now we have selected three target events: <code class="docutils literal notranslate"><span class="pre">product1</span></code>, <code class="docutils literal notranslate"><span class="pre">cart</span></code>,
<code class="docutils literal notranslate"><span class="pre">payment_done</span></code>, so we can see them in the end of matrix. Each of them
has its own palette and color scaling.</p>
<p>If we want to compare some targets and plot them using the same color
scaling, we can combine them in a sub-list inside the targets list:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span><span class="o">.</span><span class="n">step_matrix</span><span class="p">(</span>
    <span class="n">max_steps</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">thresh</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;product1&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;cart&#39;</span><span class="p">,</span> <span class="s1">&#39;payment_done&#39;</span><span class="p">]]</span>
<span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_25_2.png" src="../_images/output_25_2.png" />
<p>Now we can visually compare by color how many users reach <code class="docutils literal notranslate"><span class="pre">cart</span></code> vs
<code class="docutils literal notranslate"><span class="pre">payment_done</span></code> at particular step in their trajectory.</p>
<p>Targets can be presented as accumulated values. It means we can display
the cumulative sum of the share of the users who had this event at each
step. Rows with accumulated values start with <code class="docutils literal notranslate"><span class="pre">ACC_</span></code>. There are two
options for displaying these rows:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">only</span></code> accumulated rows;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">both</span></code> not accumulated and accumulated values, two rows with
different color scaling for each event.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span><span class="o">.</span><span class="n">step_matrix</span><span class="p">(</span>
    <span class="n">max_steps</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">thresh</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;product1&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;cart&#39;</span><span class="p">,</span> <span class="s1">&#39;payment_done&#39;</span><span class="p">]],</span>
    <span class="n">accumulated</span><span class="o">=</span><span class="s1">&#39;only&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_28_1.png" src="../_images/output_28_1.png" />
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span><span class="o">.</span><span class="n">step_matrix</span><span class="p">(</span>
    <span class="n">max_steps</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">thresh</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;product1&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;cart&#39;</span><span class="p">,</span> <span class="s1">&#39;payment_done&#39;</span><span class="p">]],</span>
    <span class="n">accumulated</span><span class="o">=</span><span class="s1">&#39;both&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_29_2.png" src="../_images/output_29_2.png" />
<section id="centered-step-matrix">
<h3>Centered step matrix<a class="headerlink" href="#centered-step-matrix" title="Permalink to this heading">#</a></h3>
<p>Sometimes we are interested in flow of users through a specific event:
how do users reach a specific event and what do they do after? This
information can be visualized with step_marix using parameter
<code class="docutils literal notranslate"><span class="pre">centered</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span><span class="o">.</span><span class="n">step_matrix</span><span class="p">(</span>
    <span class="n">max_steps</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">thresh</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">centered</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="s1">&#39;cart&#39;</span><span class="p">,</span>
        <span class="s1">&#39;left_gap&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s1">&#39;occurrence&#39;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_32_2.png" src="../_images/output_32_2.png" />
<p>Parameter <code class="docutils literal notranslate"><span class="pre">centered</span></code> is a dictionary which requires three keys:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">event</span></code> - the name of the event we are interested in. Reaching this
event will be associated with step 0. Negative step numbers will
correspond to events occurred before the selected event and positive
step numbers will correspond to steps occurred after the selected
event;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">left_gap</span></code> - the integer number which indicates how many steps
before the centered event we want to show in the step matrix;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">occurrence</span></code> - which occurrence number of the target event we are
interested in. For example, in the illustration above, all the
trajectories will be aligned to have <strong>the first</strong> ‘cart’ occurrence
as step 0.</p></li>
</ul>
<p>Importantly, when a centered step matrix is used, only users who have
selected events in their trajectories present (or it’s n`th occurrence)
will be shown. Therefore, the column with step index 0 will always have
1 at the selected event and zero at all other events. The fraction of
the users kept for the centered step matrix is shown in the title. In
the example above, 51.3% of users have reached the event ‘cart’ at least
<strong>once</strong>.</p>
<img alt="../_images/SM_occurence=1.png" src="../_images/SM_occurence=1.png" />
<p>To better understand the meaning of the <code class="docutils literal notranslate"><span class="pre">occurrence</span></code> parameter, let’s
build another step matrix, this time with <code class="docutils literal notranslate"><span class="pre">occurrence=2</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span><span class="o">.</span><span class="n">step_matrix</span><span class="p">(</span>
    <span class="n">max_steps</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">thresh</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">centered</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="s1">&#39;cart&#39;</span><span class="p">,</span>
        <span class="s1">&#39;left_gap&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s1">&#39;occurrence&#39;</span><span class="p">:</span> <span class="mi">2</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_36_2.png" src="../_images/output_36_2.png" />
<p>Here we can see that the proportion of users whose steps are displayed
in our matrix has noticeably decreased. Now they are 15.2%, because we
are evaluating the <strong>second</strong> occurrence of the <code class="docutils literal notranslate"><span class="pre">cart</span></code> event, which
means we are considering users who had this event at least <strong>twice</strong>.</p>
<p>A combination of <code class="docutils literal notranslate"><span class="pre">targets</span></code> and <code class="docutils literal notranslate"><span class="pre">centered</span></code> parameters is also
possible:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span><span class="o">.</span><span class="n">step_matrix</span><span class="p">(</span>
    <span class="n">max_steps</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">thresh</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">centered</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="s1">&#39;cart&#39;</span><span class="p">,</span>
        <span class="s1">&#39;left_gap&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s1">&#39;occurrence&#39;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">},</span>
    <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;payment_done&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_39_2.png" src="../_images/output_39_2.png" />
</section>
<section id="events-sorting">
<h3>Events sorting<a class="headerlink" href="#events-sorting" title="Permalink to this heading">#</a></h3>
<p>By default, rows in the step matrix are sorted in the next order:</p>
<ol class="arabic simple">
<li><p>real events in the order of the first occurrence in eventstream</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ENDED</span></code> event</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">THRESHOLDED</span></code> event</p></li>
<li><p>targets</p></li>
</ol>
<p>Sometimes it is needed to obtain a step matrix with the events ranked in
the specific order (for example, to compare two step matrices). This can
be done with parameter <code class="docutils literal notranslate"><span class="pre">sorting</span></code> which accepts a list of event names
in the required order to show up in the step matrix. Let’s consider an
example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span><span class="o">.</span><span class="n">step_matrix</span><span class="p">(</span><span class="n">max_steps</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">0.07</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_43_2.png" src="../_images/output_43_2.png" />
<p>Let’s say we would like to change the order of the events in the
resulted step_matrix. First, we can obtain a list of event names from
the step_matrix output using <code class="docutils literal notranslate"><span class="pre">.values[0]</span></code></p>
<p>To read about the <code class="docutils literal notranslate"><span class="pre">.values</span></code> attribute, follow the link to <a class="reference internal" href="#values"><span class="std std-ref">values</span></a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span>\
    <span class="o">.</span><span class="n">step_matrix</span><span class="p">(</span><span class="n">max_steps</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">0.07</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>\
    <span class="o">.</span><span class="n">index</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Index</span><span class="p">([</span><span class="s1">&#39;catalog&#39;</span><span class="p">,</span> <span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="s1">&#39;lost&#39;</span><span class="p">,</span> <span class="s1">&#39;cart&#39;</span><span class="p">,</span> <span class="s1">&#39;product2&#39;</span><span class="p">,</span> <span class="s1">&#39;product1&#39;</span><span class="p">,</span> <span class="s1">&#39;ENDED&#39;</span><span class="p">,</span>
       <span class="s1">&#39;THRESHOLDED_7&#39;</span><span class="p">],</span>
      <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;object&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_45_2.png" src="../_images/output_45_2.png" />
<p>Now we can conveniently copy the list of events, reorganize it in the
required order and pass it to the step_matrix function as a sorting
parameter:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">custom_order</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;main&#39;</span><span class="p">,</span>
    <span class="s1">&#39;catalog&#39;</span><span class="p">,</span>
    <span class="s1">&#39;product1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;product2&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cart&#39;</span><span class="p">,</span>
    <span class="s1">&#39;lost&#39;</span><span class="p">,</span>
    <span class="s1">&#39;THRESHOLDED_7&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ENDED&#39;</span>
<span class="p">]</span>

<span class="n">stream</span><span class="o">.</span><span class="n">step_matrix</span><span class="p">(</span>
    <span class="n">max_steps</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">thresh</span><span class="o">=</span><span class="mf">0.07</span><span class="p">,</span>
    <span class="n">sorting</span><span class="o">=</span><span class="n">custom_order</span>
<span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_47_2.png" src="../_images/output_47_2.png" />
<p>Note, that the custom ordering only affects non-target events. Target
events will always be in the same order as they are specified in the
parameter <code class="docutils literal notranslate"><span class="pre">targets</span></code>.</p>
</section>
<section id="differential-step-matrix">
<h3>Differential step_matrix<a class="headerlink" href="#differential-step-matrix" title="Permalink to this heading">#</a></h3>
<p>Sometimes we need to compare the behavior of several groups of users.
For example, when we would like to compare the behavior of the users who
had conversion to a target vs. those who had not, compare the behavior
of test and control groups in an A/B test, or compare behavior between
specific segments of the users. For example, now we want to compare the
behavior of any abstract groups g1 and g2. In g1 we will add users who
have the <code class="docutils literal notranslate"><span class="pre">payment_done</span></code> event in their trajectory, in g2 - all the
rest. We will choose <code class="docutils literal notranslate"><span class="pre">cart</span></code> as the central event, because it is
usually closely followed by a purchase or user disappearance.</p>
<p>In this case, it is informative to plot a step_matrix as the difference
between step_matrix for group_A and step_matrix for group_B. This can be
done using parameter <code class="docutils literal notranslate"><span class="pre">groups</span></code>, which requires a tuple of two elements
<code class="docutils literal notranslate"><span class="pre">(g1,</span> <span class="pre">g2)</span></code>: where <code class="docutils literal notranslate"><span class="pre">g_1</span></code> and <code class="docutils literal notranslate"><span class="pre">g_2</span></code> are collections of the
<code class="docutils literal notranslate"><span class="pre">user_id</span></code>s (list, tuple, or set). Two separate step matrices M1 and
M2 will be calculated for users from <code class="docutils literal notranslate"><span class="pre">g_1</span></code> and <code class="docutils literal notranslate"><span class="pre">g_2</span></code>, respectively.
The resulting matrix will be the matrix M = M1-M2. Note, that the values
in each column in the differential step matrix will always sum up to 0
(since the columns in both M1 and M2 always sum up to 1).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">raw_data</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>

<span class="n">g1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;event&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;payment_done&#39;</span><span class="p">][</span><span class="s1">&#39;user_id&#39;</span><span class="p">])</span>
<span class="n">g2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">g1</span>

<span class="n">stream</span><span class="o">.</span><span class="n">step_matrix</span><span class="p">(</span>
    <span class="n">max_steps</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">thresh</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">centered</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="s1">&#39;cart&#39;</span><span class="p">,</span>
        <span class="s1">&#39;left_gap&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s1">&#39;occurrence&#39;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">},</span>
    <span class="n">groups</span><span class="o">=</span><span class="p">(</span><span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_51_2.png" src="../_images/output_51_2.png" />
<p>To correctly interpret the differential matrix, it is enough to keep in
mind the idea that we have before us the result of subtracting one
matrix from another. It means that if we see a value in a matrix cell
that is equal to or close to zero, we understand that the share of this
event at this step in the two groups is approximately equal. If we see a
large negative number, then users from the second group performed this
action more often at this step. If we see a large positive number, this
means that this event happened more often for users from the first
group.</p>
<p>For example, before the central event <code class="docutils literal notranslate"><span class="pre">cart</span></code>, the values in the cells
of the matrix are close to zero, which means that the behavior of users
in the two groups is approximately the same. However, after it, negative
values appear in the <code class="docutils literal notranslate"><span class="pre">lost</span></code> and <code class="docutils literal notranslate"><span class="pre">ENDED</span></code> row, which tells us that
among users who did not make a purchase, many users were lost after
adding the product to the cart. On the contrary, users who have made a
purchase are dominated by <code class="docutils literal notranslate"><span class="pre">payment_done</span></code>, <code class="docutils literal notranslate"><span class="pre">payment_choice</span></code> and
<code class="docutils literal notranslate"><span class="pre">payment_cart</span></code> events.</p>
<section id="clusters">
<h4>Clusters<a class="headerlink" href="#clusters" title="Permalink to this heading">#</a></h4>
<p>Consider another example of differential step matrix use, where we will
compare behavior of two user clusters. First, let’s obtain behavioural
segments and visualize the results of the segmentation using conversion
to <code class="docutils literal notranslate"><span class="pre">payment_done</span></code> and event <code class="docutils literal notranslate"><span class="pre">cart</span></code>. User list is assigned by the
<a class="reference internal" href="../api/tooling/clusters.html#retentioneering.tooling.clusters.clusters.Clusters.cluster_mapping" title="retentioneering.tooling.clusters.clusters.Clusters.cluster_mapping"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Clusters.cluster_mapping</span></code></a> attribute.</p>
<p>To learn more about user behavior clustering read here: <a class="reference internal" href="clusters.html"><span class="doc">Clusters user guide</span></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">retentioneering.tooling.clusters</span> <span class="kn">import</span> <span class="n">Clusters</span>

<span class="n">clusters</span> <span class="o">=</span> <span class="n">Clusters</span><span class="p">(</span><span class="n">eventstream</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
<span class="n">clusters</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;kmeans&#39;</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">feature_type</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">ngram_range</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">clusters</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;payment_done&#39;</span><span class="p">,</span> <span class="s1">&#39;cart&#39;</span><span class="p">]);</span>
</pre></div>
</div>
<img alt="../_images/output_57_0.png" src="../_images/output_57_0.png" />
<p>We can see 8 clusters with the corresponding conversion rates to the
specified events (% of the users in the given cluster who had at least
one specified event). Suppose we would like to compare the behavior of
cluster #1 compared to cluster #3. Both have relatively high conversion
rate to <code class="docutils literal notranslate"><span class="pre">payment_done</span></code> and <code class="docutils literal notranslate"><span class="pre">cart</span></code>. Let’s find out how they differ
using differential step matrix. All we need is to get <code class="docutils literal notranslate"><span class="pre">user_id</span></code>s
collections from <code class="docutils literal notranslate"><span class="pre">cluster_mapping</span></code> attribute and pass it to <code class="docutils literal notranslate"><span class="pre">groups</span></code>
parameter of step matrix:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">g1</span> <span class="o">=</span> <span class="n">clusters</span><span class="o">.</span><span class="n">cluster_mapping</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">g2</span> <span class="o">=</span> <span class="n">clusters</span><span class="o">.</span><span class="n">cluster_mapping</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

<span class="n">stream</span><span class="o">.</span><span class="n">step_matrix</span><span class="p">(</span>
    <span class="n">max_steps</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
    <span class="n">centered</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="s1">&#39;cart&#39;</span><span class="p">,</span>
        <span class="s1">&#39;left_gap&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s1">&#39;occurrence&#39;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">},</span>
    <span class="n">groups</span><span class="o">=</span><span class="p">(</span><span class="n">g1</span><span class="p">,</span><span class="n">g2</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_59_1.png" src="../_images/output_59_1.png" />
<p>In this step matrix, we can see the difference between clusters #1 and
#3. Users from cluster #1, after adding the product to the cart, more
often returned to the catalog and continued shopping. Users from cluster
#3 usually made a payment and finished their trajectory through the
online shop after the <code class="docutils literal notranslate"><span class="pre">cart</span></code> event.</p>
</section>
</section>
</section>
<section id="weight-col">
<h2>Weight_col<a class="headerlink" href="#weight-col" title="Permalink to this heading">#</a></h2>
<p>So far we have been calculating step matrix values as the percentage of
the users appearing in the clickstream at a certain step. However,
sometimes it is reasonable to calculate similar fractions not over
users, but over other entities as well. For example, over sessions.</p>
<p>To do this, we need to divide the event stream into sessions. The split
sessions method will help us with this.</p>
<p>We will set the length of the session - 100 minutes. The resulting
object will be a new eventstream.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">split_sessions</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span><span class="s1">&#39;m&#39;</span><span class="p">),</span> <span class="n">session_col</span><span class="o">=</span><span class="s1">&#39;session_id&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>To learn more about working with data processors, you can follow the
link:
<a class="reference internal" href="dataprocessors.html"><span class="doc">dataprocessors user guide</span></a>.</p>
<p>&#64;TODO: link to .timedelta_hist() method</p>
<p>Now we feed the result as input to the step_matrix tool and specify the
<code class="docutils literal notranslate"><span class="pre">weight_col=['session_id']</span></code> parameter.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">result</span><span class="o">.</span><span class="n">step_matrix</span><span class="p">(</span><span class="n">max_steps</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">weight_col</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;session_id&#39;</span><span class="p">])</span>
</pre></div>
</div>
<img alt="../_images/output_69_2.png" src="../_images/output_69_2.png" />
<p>Now we see in the cells the share of all sessions for which the
specified event happened at the specified step.</p>
<p>Let’s compare the result with the user-weighted matrix</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">result</span><span class="o">.</span><span class="n">step_matrix</span><span class="p">(</span><span class="n">max_steps</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">weight_col</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]))</span>
</pre></div>
</div>
<img alt="../_images/output_72_2.png" src="../_images/output_72_2.png" />
<p>Now we can see the difference between these two types of normalisation.
The number of unique sessions is greater than the number of unique
users, so the proportion of the <code class="docutils literal notranslate"><span class="pre">cart</span></code> event in the third step when
normalizing by users is higher than for sessions (0,09 vs 0,05). The
same happens with other, potentially targeted events in the eventstream:
<code class="docutils literal notranslate"><span class="pre">payment_choice</span></code>, <code class="docutils literal notranslate"><span class="pre">payment_done</span></code>, <code class="docutils literal notranslate"><span class="pre">delivery_choice</span></code> etc. In
addition, looking at the step matrix by users, we can assume that the
trajectory of most users starts with the <code class="docutils literal notranslate"><span class="pre">catalogue</span></code> event, but if you
break down the trajectories into sessions, it becomes clear that most of
them start with the <code class="docutils literal notranslate"><span class="pre">main</span></code> event.</p>
</section>
<section id="using-a-separate-instance">
<h2>Using a separate instance<a class="headerlink" href="#using-a-separate-instance" title="Permalink to this heading">#</a></h2>
<p>By design, <code class="docutils literal notranslate"><span class="pre">Eventstream.step_matrix()</span></code> is a shortcut method which uses
an instance of <code class="docutils literal notranslate"><span class="pre">StepMatrix</span></code> class under the hood. Eventstream method
creates an instance of StepMatrix object and stores it the eventstream
internally.</p>
<p>Sometimes it’s reasonable to work with a separate instance of StepMatrix
class. In this case you also have to call <code class="docutils literal notranslate"><span class="pre">StepMatrix.fit()</span></code> and
<code class="docutils literal notranslate"><span class="pre">StepMatrix.plot()</span></code> methods explicitly. Here’s an example how you can
do it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">retentioneering.tooling.step_matrix</span> <span class="kn">import</span> <span class="n">StepMatrix</span>

<span class="n">step_matrix</span> <span class="o">=</span> <span class="n">StepMatrix</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;payment_done&#39;</span><span class="p">])</span>
<span class="n">step_matrix</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">step_matrix</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/output_75_0.png" src="../_images/output_75_0.png" />
</section>
<section id="common-tooling-properties">
<h2>Common tooling properties<a class="headerlink" href="#common-tooling-properties" title="Permalink to this heading">#</a></h2>
<p>Regardless of how the step matrix is called, as eventstream method or as
StepMatrix class instance, common properties are available.</p>
<section id="values">
<span id="id1"></span><h3>values<a class="headerlink" href="#values" title="Permalink to this heading">#</a></h3>
<p>To see the matrix data, we can call the <code class="docutils literal notranslate"><span class="pre">.values</span></code> attribute. This
attribute returns two datasets: the step matrix itself and the target
events. If we apply indexing, .values[0] returns step_matrix, .values[1]
returns targets.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span><span class="o">.</span><span class="n">step_matrix</span><span class="p">(</span>
    <span class="n">max_steps</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;product1&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;cart&#39;</span><span class="p">,</span> <span class="s1">&#39;payment_done&#39;</span><span class="p">]],</span>
    <span class="n">show_plot</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>10</th>
      <th>11</th>
      <th>12</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>catalog</th>
      <td>0.716076</td>
      <td>0.445215</td>
      <td>0.384164</td>
      <td>0.310051</td>
      <td>0.251400</td>
      <td>0.211677</td>
      <td>0.169022</td>
      <td>0.147427</td>
      <td>0.134897</td>
      <td>0.117835</td>
      <td>0.101840</td>
      <td>0.094908</td>
    </tr>
    <tr>
      <th>main</th>
      <td>0.283924</td>
      <td>0.162357</td>
      <td>0.121834</td>
      <td>0.094108</td>
      <td>0.085311</td>
      <td>0.079712</td>
      <td>0.070914</td>
      <td>0.064250</td>
      <td>0.053586</td>
      <td>0.050120</td>
      <td>0.049853</td>
      <td>0.037057</td>
    </tr>
    <tr>
      <th>lost</th>
      <td>0.000000</td>
      <td>0.118102</td>
      <td>0.101306</td>
      <td>0.093842</td>
      <td>0.075180</td>
      <td>0.066649</td>
      <td>0.060784</td>
      <td>0.054385</td>
      <td>0.040523</td>
      <td>0.035724</td>
      <td>0.023460</td>
      <td>0.022661</td>
    </tr>
    <tr>
      <th>cart</th>
      <td>0.000000</td>
      <td>0.089843</td>
      <td>0.109571</td>
      <td>0.080778</td>
      <td>0.064783</td>
      <td>0.047454</td>
      <td>0.046388</td>
      <td>0.031725</td>
      <td>0.027459</td>
      <td>0.024527</td>
      <td>0.021061</td>
      <td>0.022394</td>
    </tr>
    <tr>
      <th>payment_choice</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.033591</td>
      <td>0.043455</td>
      <td>0.031991</td>
      <td>0.023994</td>
      <td>0.022661</td>
      <td>0.017329</td>
      <td>0.010131</td>
      <td>0.011464</td>
    </tr>
    <tr>
      <th>delivery_choice</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.054119</td>
      <td>0.061584</td>
      <td>0.049054</td>
      <td>0.034391</td>
      <td>0.031725</td>
      <td>0.026926</td>
      <td>0.018395</td>
      <td>0.018395</td>
      <td>0.014396</td>
      <td>0.012263</td>
    </tr>
    <tr>
      <th>payment_done</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.003999</td>
      <td>0.024793</td>
      <td>0.024793</td>
      <td>0.018395</td>
      <td>0.014929</td>
      <td>0.013063</td>
      <td>0.010131</td>
    </tr>
    <tr>
      <th>product2</th>
      <td>0.000000</td>
      <td>0.114370</td>
      <td>0.065849</td>
      <td>0.057851</td>
      <td>0.045854</td>
      <td>0.035724</td>
      <td>0.030392</td>
      <td>0.023727</td>
      <td>0.020794</td>
      <td>0.020261</td>
      <td>0.017595</td>
      <td>0.016262</td>
    </tr>
    <tr>
      <th>product1</th>
      <td>0.000000</td>
      <td>0.070115</td>
      <td>0.045055</td>
      <td>0.042655</td>
      <td>0.031991</td>
      <td>0.025860</td>
      <td>0.020794</td>
      <td>0.017595</td>
      <td>0.017062</td>
      <td>0.011197</td>
      <td>0.012263</td>
      <td>0.010397</td>
    </tr>
    <tr>
      <th>payment_card</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.017595</td>
      <td>0.020261</td>
      <td>0.017062</td>
      <td>0.012797</td>
      <td>0.010664</td>
      <td>0.010131</td>
      <td>0.005065</td>
    </tr>
    <tr>
      <th>delivery_courier</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.025327</td>
      <td>0.032791</td>
      <td>0.024793</td>
      <td>0.015729</td>
      <td>0.017595</td>
      <td>0.011997</td>
      <td>0.007465</td>
      <td>0.007731</td>
      <td>0.006398</td>
    </tr>
    <tr>
      <th>delivery_pickup</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.014396</td>
      <td>0.016796</td>
      <td>0.015463</td>
      <td>0.012530</td>
      <td>0.009597</td>
      <td>0.010131</td>
      <td>0.005332</td>
      <td>0.007198</td>
      <td>0.003999</td>
    </tr>
    <tr>
      <th>payment_cash</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.004799</td>
      <td>0.006931</td>
      <td>0.004799</td>
      <td>0.004266</td>
      <td>0.004532</td>
      <td>0.002133</td>
      <td>0.001866</td>
    </tr>
    <tr>
      <th>ENDED</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.118102</td>
      <td>0.219408</td>
      <td>0.313250</td>
      <td>0.388430</td>
      <td>0.457745</td>
      <td>0.536124</td>
      <td>0.607038</td>
      <td>0.661690</td>
      <td>0.709144</td>
      <td>0.745135</td>
    </tr>
  </tbody>
</table>
</div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># target events</span>
<span class="n">stream</span><span class="o">.</span><span class="n">step_matrix</span><span class="p">(</span>
    <span class="n">max_steps</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;product1&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;cart&#39;</span><span class="p">,</span> <span class="s1">&#39;payment_done&#39;</span><span class="p">]],</span>
    <span class="n">show_plot</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<div><table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>10</th>
      <th>11</th>
      <th>12</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>product1</th>
      <td>0.0</td>
      <td>0.070115</td>
      <td>0.045055</td>
      <td>0.042655</td>
      <td>0.031991</td>
      <td>0.025860</td>
      <td>0.020794</td>
      <td>0.017595</td>
      <td>0.017062</td>
      <td>0.011197</td>
      <td>0.012263</td>
      <td>0.010397</td>
    </tr>
    <tr>
      <th>cart</th>
      <td>0.0</td>
      <td>0.089843</td>
      <td>0.109571</td>
      <td>0.080778</td>
      <td>0.064783</td>
      <td>0.047454</td>
      <td>0.046388</td>
      <td>0.031725</td>
      <td>0.027459</td>
      <td>0.024527</td>
      <td>0.021061</td>
      <td>0.022394</td>
    </tr>
    <tr>
      <th>payment_done</th>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.003999</td>
      <td>0.024793</td>
      <td>0.024793</td>
      <td>0.018395</td>
      <td>0.014929</td>
      <td>0.013063</td>
      <td>0.010131</td>
    </tr>
  </tbody>
</table>
</div></section>
<section id="params">
<h3>params<a class="headerlink" href="#params" title="Permalink to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">StepMatrix.params</span></code> property returns a dictionary containing all the
parameters (including the defaults) related to the current state of the
StepMatrix object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span><span class="o">.</span><span class="n">step_matrix</span><span class="p">(</span><span class="n">show_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">params</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;max_steps&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
 <span class="s1">&#39;weight_col&#39;</span><span class="p">:</span> <span class="s1">&#39;user_id&#39;</span><span class="p">,</span>
 <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
 <span class="s1">&#39;targets&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
 <span class="s1">&#39;accumulated&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
 <span class="s1">&#39;sorting&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
 <span class="s1">&#39;thresh&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
 <span class="s1">&#39;centered&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
 <span class="s1">&#39;groups&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
</pre></div>
</div>
</section>
</section>
</section>


            </article>
            
            
            
            <footer class="bd-footer-article">
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
  <a class='left-prev' id="prev-link" href="transition_graph.html" title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
          <p class="prev-next-subtitle">previous</p>
          <p class="prev-next-title">Transition Graph</p>
      </div>
  </a>
  <a class='right-next' id="next-link" href="step_sankey.html" title="next page">
  <div class="prev-next-info">
      <p class="prev-next-subtitle">next</p>
      <p class="prev-next-title">StepSankey</p>
  </div>
  <i class="fa-solid fa-angle-right"></i>
  </a>
</div>
            </footer>
            
          </div>
          
          
          
            <div class="bd-sidebar-secondary bd-toc">
              
<div class="toc-item">
  
<div class="tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
</div>
<nav id="bd-toc-nav" class="page-toc">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-matrix-definition">
   Step matrix definition
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#loading-data">
     Loading data
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#basic-example">
   Basic example
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#terminating-event">
   Terminating event
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#collapsing-rare-events">
   Collapsing rare events
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#targets-analysis">
   Targets analysis
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#centered-step-matrix">
     Centered step matrix
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#events-sorting">
     Events sorting
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#differential-step-matrix">
     Differential step_matrix
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#clusters">
       Clusters
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#weight-col">
   Weight_col
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-a-separate-instance">
   Using a separate instance
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#common-tooling-properties">
   Common tooling properties
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#values">
     values
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#params">
     params
    </a>
   </li>
  </ul>
 </li>
</ul>

</nav>
</div>

<div class="toc-item">
  
<div id="searchbox"></div>
</div>

<div class="toc-item">
  
</div>

<div class="toc-item">
  
<div class="tocsection sourcelink">
    <a href="../_sources/user_guides/step_matrix.rst.txt">
        <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
</div>

</div>

            </div>
          
          
        </div>
        <footer class="bd-footer-content">
          <div class="bd-footer-content__inner">
            
          </div>
        </footer>
        
      </main>
    </div>
  </div>

  
    
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94"></script>

 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>

  </body>
</html>